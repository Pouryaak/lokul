---
phase: 02-chat-interface
plan: 03
type: execute
wave: 2
depends_on: ["02-01", "02-02"]
files_modified:
  - src/components/chat/MarkdownMessage.tsx
  - src/components/chat/CodeBlock.tsx
  - src/components/chat/MessageBubble.tsx
  - src/components/chat/ChatInterface.tsx
  - src/App.tsx
autonomous: true
requirements:
  - CHAT-04
  - CHAT-05
  - CHAT-06
must_haves:
  truths:
    - Messages render with Markdown formatting (bold, italic, lists, code blocks)
    - Code blocks display with syntax highlighting
    - User can copy code blocks with one click
    - Full markdown support including tables, lists, headings
  artifacts:
    - path: src/components/chat/MarkdownMessage.tsx
      provides: Markdown rendering with remark-gfm
      exports: ["MarkdownMessage"]
    - path: src/components/chat/CodeBlock.tsx
      provides: Syntax highlighted code blocks with copy button
      exports: ["CodeBlock"]
    - path: src/components/chat/ChatInterface.tsx
      provides: Main chat container composing all components
      exports: ["ChatInterface"]
  key_links:
    - from: MarkdownMessage.tsx
      to: react-markdown
      via: Component integration
      pattern: "import ReactMarkdown from 'react-markdown'"
    - from: MarkdownMessage.tsx
      to: CodeBlock.tsx
      via: Custom code component
      pattern: "components={{ code: CodeBlock }}"
    - from: MessageBubble.tsx
      to: MarkdownMessage.tsx
      via: Conditional rendering for AI messages
      pattern: "{isUser ? <p> : <MarkdownMessage />}"
---

<objective>
Integrate Markdown rendering and create the main ChatInterface component.

Purpose: Enable rich message formatting with Markdown and assemble all chat components into the main interface.
Output: MarkdownMessage component with syntax highlighting, CodeBlock component, and ChatInterface container.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-chat-interface/02-CONTEXT.md
@.planning/phases/02-chat-interface/02-RESEARCH.md
@src/components/chat/MessageBubble.tsx
@src/components/chat/MessageInput.tsx
@src/components/chat/MessageList.tsx
@src/components/chat/ChatToolbar.tsx
@src/components/chat/WelcomeScreen.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CodeBlock component with syntax highlighting</name>
  <files>src/components/chat/CodeBlock.tsx</files>
  <action>
    Create src/components/chat/CodeBlock.tsx:

    1. Import React, useState, useCallback from 'react'
    2. Import { Prism as SyntaxHighlighter } from 'react-syntax-highlighter'
    3. Import { oneDark } from 'react-syntax-highlighter/dist/esm/styles/prism'
    4. Import { Copy, Check } from 'lucide-react'
    5. Import { Button } from '@/components/ui/Button'
    6. Import { cn } from '@/lib/utils'

    7. Define CodeBlockProps interface:
       - code: string
       - language?: string
       - className?: string

    8. Create CodeBlock component:
       - Use useState for copied state
       - Implement handleCopy with navigator.clipboard
       - Determine language from props (default to 'text')

    9. Render structure:
       - Container div with relative positioning
       - Header bar (flex, justify-between, align-center):
         * Language label (uppercase, small text)
         * Copy button with Copy/Check icon
       - SyntaxHighlighter component:
         * language={language}
         * style={oneDark}
         * showLineNumbers (optional, based on line count)
         * wrapLongLines
       - Style with rounded-lg, overflow-hidden, border

    10. Handle language detection:
        - Parse from className like "language-typescript"
        - Extract after "language-" prefix
        - Default to "text" if no match

    Follow CLAUDE.md component patterns and keep under 200 lines.
  </action>
  <verify>
    npm run type-check passes
    grep -E "(CodeBlock|SyntaxHighlighter|oneDark)" src/components/chat/CodeBlock.tsx
  </verify>
  <done>
    CodeBlock component exists with syntax highlighting and copy functionality
  </done>
</task>

<task type="auto">
  <name>Task 2: Create MarkdownMessage component</name>
  <files>src/components/chat/MarkdownMessage.tsx</files>
  <action>
    Create src/components/chat/MarkdownMessage.tsx:

    1. Import React from 'react'
    2. Import ReactMarkdown from 'react-markdown'
    3. Import remarkGfm from 'remark-gfm'
    4. Import { CodeBlock } from './CodeBlock'
    5. Import { cn } from '@/lib/utils'

    6. Define MarkdownMessageProps interface:
       - content: string
       - className?: string

    7. Create MarkdownMessage component:
       - Use ReactMarkdown with remarkGfm plugin
       - Configure components prop for custom rendering

    8. Custom components configuration:
       - code: Custom renderer that:
         * Checks if inline (node?.position?.start?.line === node?.position?.end?.line)
         * If inline: render <code> with styling
         * If block: render <CodeBlock> with language detection
       - pre: Render as div (avoid nesting issues)
       - p: Add mb-4 for paragraph spacing
       - ul/ol: Add list-disc/list-decimal, pl-5, mb-4
       - li: Add mb-1
       - h1-h6: Add font-bold, appropriate sizes, mb-4
       - blockquote: Add border-l-4, pl-4, italic, text-gray-600
       - table: Add w-full, border-collapse
       - th/td: Add border, px-4, py-2
       - a: Add text-[#FF6B35], hover:underline
       - strong: Add font-bold
       - em: Add italic
       - hr: Add my-4, border-gray-200

    9. Container styling:
       - prose class for base typography
       - max-w-none to allow full width
       - prose-pre:my-0 to remove extra margins around code blocks

    10. Security: Do NOT use rehype-raw to avoid XSS
        - react-markdown escapes HTML by default
        - This is the safe behavior

    Follow CLAUDE.md patterns and research findings about XSS prevention.
  </action>
  <verify>
    npm run type-check passes
    grep -E "(ReactMarkdown|remarkGfm|CodeBlock)" src/components/chat/MarkdownMessage.tsx
  </verify>
  <done>
    MarkdownMessage component exists with full markdown support and code block integration
  </done>
</task>

<task type="auto">
  <name>Task 3: Update MessageBubble and create ChatInterface</name>
  <files>src/components/chat/MessageBubble.tsx, src/components/chat/ChatInterface.tsx, src/App.tsx</files>
  <action>
    Update MessageBubble and create ChatInterface:

    **Update src/components/chat/MessageBubble.tsx:**
    1. Import MarkdownMessage from './MarkdownMessage'
    2. In render, for AI messages:
       - Replace <p> with <MarkdownMessage content={message.content} />
    3. For streaming AI message:
       - Also use MarkdownMessage with streamingContent

    **Create src/components/chat/ChatInterface.tsx:**
    1. Import all chat components:
       - MessageList, MessageInput, ChatToolbar, WelcomeScreen
    2. Import useChat hook
    3. Import useState for any local UI state
    4. Import { cn } from '@/lib/utils'

    5. Define ChatInterfaceProps interface:
       - className?: string

    6. Create ChatInterface component:
       - Get from useChat:
         * messages
         * isStreaming
         * streamingContent
         * sendMessage
         * stopGeneration
         * clearChat
         * regenerateMessage
         * error

       - Render structure:
         * Container: flex, flex-col, h-full, bg-[#FFF8F0] (warm cream)
         * Message area: flex-1, overflow-hidden, relative
           - If messages.length === 0: Show WelcomeScreen
           - Else: Show MessageList
         * Error banner (if error): Red background, white text, dismissible
         * Toolbar: ChatToolbar with regenerate/clear actions
         * Input area: MessageInput at bottom

       - Implement suggestion click handler:
         * Calls sendMessage with suggestion text

       - Implement send handler:
         * Validates content not empty
         * Calls sendMessage

    7. Style considerations:
       - Max width container for readability (max-w-4xl mx-auto)
       - Proper spacing between sections
       - Responsive padding

    **Update src/App.tsx:**
    1. Import ChatInterface from '@/components/chat/ChatInterface'
    2. Replace current landing content with ChatInterface
    3. Keep StatusIndicator and PerformancePanel from Phase 1
    4. Layout: Sidebar (future) + ChatInterface main area
    5. For now: Full-width ChatInterface with StatusIndicator fixed bottom-left

    Ensure all imports resolve and TypeScript compiles.
  </action>
  <verify>
    npm run type-check passes
    npm run build (check for runtime errors)
    grep -E "(ChatInterface|MarkdownMessage)" src/components/chat/*.tsx src/App.tsx
  </verify>
  <done>
    MessageBubble uses MarkdownMessage for AI content, ChatInterface composes all components, App.tsx renders the chat
  </done>
</task>

</tasks>

<verification>
- MarkdownMessage renders all markdown elements correctly
- CodeBlock provides syntax highlighting with copy button
- MessageBubble conditionally uses MarkdownMessage for AI messages
- ChatInterface composes all components into cohesive UI
- App.tsx displays the chat interface
</verification>

<success_criteria>
- AI messages render with Markdown formatting
- Code blocks show syntax highlighting
- Copy button on code blocks works
- Tables, lists, headings display correctly
- Chat interface is functional end-to-end
</success_criteria>

<output>
After completion, create `.planning/phases/02-chat-interface/02-03-SUMMARY.md`
</output>
