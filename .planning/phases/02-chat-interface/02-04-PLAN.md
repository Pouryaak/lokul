---
phase: 02-chat-interface
plan: 04
type: execute
wave: 2
depends_on: ["02-01", "02-02"]
files_modified:
  - src/components/sidebar/ConversationSidebar.tsx
  - src/components/sidebar/ConversationItem.tsx
  - src/components/sidebar/EditTitleModal.tsx
  - src/components/ui/ConfirmDialog.tsx
  - src/hooks/useConversations.ts
  - src/App.tsx
autonomous: false
requirements:
  - STOR-02
  - STOR-03
  - STOR-04
  - PERF-03
  - PERF-04
  - PERF-06
  - PERF-07
must_haves:
  truths:
    - Conversation list displays in sidebar with titles and timestamps
    - User can view previous conversations from sidebar
    - User can delete a conversation with confirmation
    - Titles are editable by user
    - Performance panel shows tokens/second and response time
    - Warning displayed if memory usage exceeds 75%
    - Suggestion to switch to Quick Mode shown if performance degrades
  artifacts:
    - path: src/components/sidebar/ConversationSidebar.tsx
      provides: Main sidebar with conversation list
      exports: ["ConversationSidebar"]
    - path: src/components/sidebar/ConversationItem.tsx
      provides: Individual conversation row with actions
      exports: ["ConversationItem"]
    - path: src/components/sidebar/EditTitleModal.tsx
      provides: Modal for editing conversation titles
      exports: ["EditTitleModal"]
    - path: src/components/ui/ConfirmDialog.tsx
      provides: Reusable confirmation dialog
      exports: ["ConfirmDialog"]
  key_links:
    - from: ConversationSidebar.tsx
      to: useConversations hook
      via: Data fetching
      pattern: "const { conversations, loadConversation } = useConversations()"
    - from: ConversationItem.tsx
      to: EditTitleModal
      via: Edit action
      pattern: "setIsEditing(true)"
    - from: ConversationItem.tsx
      to: ConfirmDialog
      via: Delete action
      pattern: "setShowDeleteConfirm(true)"
    - from: useConversations.ts
      to: Performance.memory API
      via: Memory monitoring
      pattern: "performance.memory?.usedJSHeapSize"
---

<objective>
Create the conversation sidebar with history management and integrate performance monitoring.

Purpose: Enable users to manage their conversation history and monitor AI performance metrics.
Output: Complete sidebar with conversation list, title editing, delete confirmation, and performance monitoring hooks.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-chat-interface/02-CONTEXT.md
@.planning/phases/02-chat-interface/02-RESEARCH.md
@src/hooks/useConversations.ts
@src/components/ui/Button.tsx
@src/store/chatStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ConfirmDialog and EditTitleModal components</name>
  <files>src/components/ui/ConfirmDialog.tsx, src/components/sidebar/EditTitleModal.tsx</files>
  <action>
    Create reusable dialog components:

    **src/components/ui/ConfirmDialog.tsx:**
    1. Import Dialog components from @radix-ui/react-dialog (or create custom)
    2. Import { Button } from './Button'
    3. Import { AlertTriangle } from 'lucide-react'
    4. Define ConfirmDialogProps:
       - isOpen: boolean
       - onClose: () => void
       - onConfirm: () => void
       - title: string
       - description: string
       - confirmText?: string (default: "Confirm")
       - cancelText?: string (default: "Cancel")
       - variant?: 'danger' | 'warning' | 'info' (default: 'warning')

    5. Render modal overlay with:
       - Centered dialog card (white bg, rounded-2xl, shadow-xl)
       - Icon based on variant (AlertTriangle for danger/warning)
       - Title (text-lg, font-semibold)
       - Description (text-gray-600)
       - Button row: Cancel (secondary), Confirm (primary/danger)
       - Click outside or Escape to close

    **src/components/sidebar/EditTitleModal.tsx:**
    1. Import useState, useEffect from 'react'
    2. Import { Button } from '@/components/ui/Button'
    3. Define EditTitleModalProps:
       - isOpen: boolean
       - onClose: () => void
       - onSave: (title: string) => void
       - currentTitle: string

    4. Render modal with:
       - Title input (auto-focused, currentTitle pre-filled)
       - Character limit indicator (e.g., max 50 chars)
       - Save and Cancel buttons
       - Enter key saves, Escape closes

    5. Implement validation:
       - Title cannot be empty
       - Title max 50 characters
       - Trim whitespace

    Follow CLAUDE.md modal patterns and accessibility guidelines.
  </action>
  <verify>
    npm run type-check passes
    grep -E "(ConfirmDialog|EditTitleModal)" src/components/**/*.tsx
  </verify>
  <done>
    Both dialog components exist with proper props and styling
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ConversationItem component</name>
  <files>src/components/sidebar/ConversationItem.tsx</files>
  <action>
    Create src/components/sidebar/ConversationItem.tsx:

    1. Import React, useState, useCallback from 'react'
    2. Import { MessageSquare, Trash2, Pencil, Check } from 'lucide-react'
    3. Import { cn } from '@/lib/utils'
    4. Import type { Conversation } from '@/types/index'
    5. Import { EditTitleModal } from './EditTitleModal'
    6. Import { ConfirmDialog } from '@/components/ui/ConfirmDialog'

    7. Define ConversationItemProps:
       - conversation: Conversation
       - isActive: boolean
       - onClick: () => void
       - onDelete: (id: string) => void
       - onEditTitle: (id: string, title: string) => void

    8. Create ConversationItem component:
       - Use useState for:
         * isEditing (boolean)
         * showDeleteConfirm (boolean)
         * isHovered (boolean)

    9. Render structure:
       - Container button/row:
         * flex, items-center, gap-3, p-3
         * rounded-xl
         * hover:bg-gray-100
         * isActive: bg-orange-50 border-l-4 border-[#FF6B35]
         * onClick={onClick}
         * onMouseEnter={() => setIsHovered(true)}
         * onMouseLeave={() => setIsHovered(false)}

       - Icon: MessageSquare (h-4 w-4, text-gray-500)

       - Content area (flex-1, min-w-0):
         * Title: truncate, text-sm, font-medium
         * Relative timestamp: text-xs, text-gray-500 (e.g., "2 hours ago")

       - Actions (visible on hover or if active):
         * Edit button (Pencil icon) - opens EditTitleModal
         * Delete button (Trash2 icon) - opens ConfirmDialog

    10. Implement formatRelativeTime helper:
        - Input: timestamp (number)
        - Output: "just now", "5m ago", "2h ago", "yesterday", "3d ago", etc.

    11. Render modals:
        - EditTitleModal (isOpen={isEditing})
        - ConfirmDialog (isOpen={showDeleteConfirm})

    Follow CLAUDE.md component patterns. Keep under 200 lines.
  </action>
  <verify>
    npm run type-check passes
    grep -E "(ConversationItem|EditTitleModal|ConfirmDialog)" src/components/sidebar/ConversationItem.tsx
  </verify>
  <done>
    ConversationItem component exists with hover actions, edit modal, and delete confirmation
  </done>
</task>

<task type="auto">
  <name>Task 3: Create ConversationSidebar and update useConversations</name>
  <files>src/components/sidebar/ConversationSidebar.tsx, src/hooks/useConversations.ts</files>
  <action>
    Create sidebar and enhance useConversations hook:

    **Update src/hooks/useConversations.ts:**
    1. Add performance monitoring state:
       - memoryUsageMB: number | null
       - memoryWarning: boolean
       - performanceSuggestion: string | null

    2. Add useEffect for memory monitoring:
       - Check if performance.memory exists (Chrome only)
       - Calculate usedJSHeapSize / totalJSHeapSize * 100
       - Set memoryWarning if > 75%
       - Poll every 5 seconds while component mounted

    3. Add useEffect for performance degradation detection:
       - Track recent tokensPerSecond from chatStore
       - If TPS < 5 for extended period, suggest Quick Mode
       - Set performanceSuggestion message

    4. Add editTitle function:
       - Calls updateConversationTitle from storage
       - Refreshes conversation list

    5. Return additional values:
       - memoryUsageMB
       - memoryWarning
       - performanceSuggestion
       - editTitle function

    **Create src/components/sidebar/ConversationSidebar.tsx:**
    1. Import useConversations hook
    2. Import { ConversationItem } from './ConversationItem'
    3. Import { Button } from '@/components/ui/Button'
    4. Import { Plus, PanelLeft, AlertTriangle, Zap } from 'lucide-react'
    5. Import { cn } from '@/lib/utils'
    6. Import { useChatStore } from '@/store/chatStore'

    7. Define ConversationSidebarProps:
       - isOpen: boolean
       - onToggle: () => void
       - onNewChat: () => void
       - className?: string

    8. Create ConversationSidebar component:
       - Get from useConversations:
         * conversations
         * loadConversation
         * deleteConversation
         * editTitle
         * memoryWarning
         * performanceSuggestion
         * clearPerformanceSuggestion (add this)

       - Get currentConversationId from useChatStore

    9. Render structure:
       - Container aside:
         * Fixed or relative positioning based on isOpen
         * Width: 280px when open, 0 when closed
         * bg-white, border-r, h-full
         * Transition for smooth open/close

       - Header:
         * "Conversations" title
         * New chat button (Plus icon)
         * Toggle button (PanelLeft icon)

       - Warning banners (conditional):
         * Memory warning: Yellow banner with AlertTriangle
         * Performance suggestion: Blue banner with Zap, dismissible

       - Conversation list:
         * Scrollable container (flex-1, overflow-y-auto)
         * Map conversations to ConversationItem
         * Pass isActive={conversation.id === currentConversationId}

       - Empty state (if no conversations):
         * "No conversations yet" message
         * Subtle styling

    10. Implement handlers:
        - handleNewChat: calls onNewChat, could also create new conversation
        - handleLoadConversation: calls loadConversation
        - handleDeleteConversation: calls deleteConversation
        - handleEditTitle: calls editTitle

    Follow CLAUDE.md patterns. Sidebar should be collapsible on mobile.
  </action>
  <verify>
    npm run type-check passes
    grep -E "(ConversationSidebar|memoryWarning|performanceSuggestion)" src/components/sidebar/ConversationSidebar.tsx src/hooks/useConversations.ts
  </verify>
  <done>
    ConversationSidebar exists with conversation list, memory warnings, and performance suggestions
  </done>
</task>

<task type="auto">
  <name>Task 4: Integrate sidebar into App.tsx and add performance panel updates</name>
  <files>src/App.tsx</files>
  <action>
    Update App.tsx to integrate sidebar and complete the chat interface:

    1. Import ConversationSidebar from '@/components/sidebar/ConversationSidebar'
    2. Import { useState } from 'react'
    3. Import { useChatStore } for clearChat action

    4. Add state:
       - sidebarOpen: boolean (default: true on desktop, false on mobile)
       - Use useEffect or window.innerWidth to detect mobile

    5. Get from useChatStore:
       - clearChat action
       - currentConversationId

    6. Update layout structure:
       - Root: flex, h-screen, overflow-hidden
       - Sidebar: ConversationSidebar (fixed width, toggleable)
       - Main content: flex-1, flex flex-col
         * ChatInterface (from previous plan)
         * StatusIndicator (fixed bottom-left)
         * PerformancePanel (toggleable top-right)

    7. Implement handlers:
       - handleNewChat: calls clearChat() from chatStore
       - handleToggleSidebar: toggles sidebarOpen state

    8. Pass props to ConversationSidebar:
       - isOpen={sidebarOpen}
       - onToggle={handleToggleSidebar}
       - onNewChat={handleNewChat}

    9. Update PerformancePanel integration:
       - Ensure it receives metrics from chatStore
       - Display tokensPerSecond and responseTimeMs
       - Show in compact format

    10. Responsive considerations:
        - On mobile: sidebar overlays content or pushes it
        - On desktop: sidebar is always visible or collapsible
        - Use Tailwind responsive classes (md:, lg:)

    Ensure all components work together and TypeScript compiles.
  </action>
  <verify>
    npm run type-check passes
    npm run build
    grep -E "(ConversationSidebar|sidebarOpen|handleNewChat)" src/App.tsx
  </verify>
  <done>
    App.tsx integrates sidebar with main chat interface, responsive layout works
  </done>
</task>

</tasks>

<verification>
- Sidebar displays conversation list with titles and timestamps
- Clicking conversation loads it into chat
- Edit title modal works and persists changes
- Delete shows confirmation dialog before removing
- Memory warning displays when usage exceeds 75%
- Performance suggestion appears when TPS is low
- Layout is responsive (sidebar collapsible on mobile)
</verification>

<success_criteria>
- User can see all conversations in sidebar
- User can click to load previous conversations
- User can edit conversation titles
- User can delete conversations with confirmation
- Memory warning appears at 75% usage
- Quick Mode suggestion appears when performance degrades
- Sidebar is collapsible/responsive
</success_criteria>

<output>
After completion, create `.planning/phases/02-chat-interface/02-04-SUMMARY.md`
</output>
