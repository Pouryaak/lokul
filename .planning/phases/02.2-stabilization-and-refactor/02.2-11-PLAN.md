---
phase: 02.2-stabilization-and-refactor
plan: 11
type: execute
wave: 2
depends_on: ["02.2-10"]
files_modified:
  - src/hooks/useAIChat.ts
  - src/hooks/useConversations.ts
  - src/lib/ai/webllm-transport.ts
  - src/lib/ai/
  - src/hooks/
  - eslint.config.js
  - package.json
autonomous: true
gap_closure: true
requirements:
  - TECH-14
must_haves:
  truths:
    - "Function-size policy (<= 50 lines) is met for previously failing core paths"
    - "Architecture fitness checks enforce the 50-line function cap across application code, not just three files"
    - "New size-limit regressions fail lint/CI before merge"
  artifacts:
    - path: "src/hooks/useAIChat.ts"
      provides: "Persistence/generation orchestration split into <=50-line focused helpers"
      max_function_lines: 50
    - path: "src/hooks/useConversations.ts"
      provides: "Conversation list orchestration decomposed into small pure helpers"
      max_function_lines: 50
    - path: "src/lib/ai/webllm-transport.ts"
      provides: "Transport send flow decomposed into <=50-line units"
      max_function_lines: 50
    - path: "eslint.config.js"
      provides: "Project-wide max-lines-per-function enforcement aligned to 50-line policy"
      contains: "broader TS/TSX scope with explicit allowlist exceptions"
  key_links:
    - from: "eslint.config.js"
      to: "package.json"
      via: "lint script executing architecture fitness rules"
      pattern: "max-lines-per-function"
    - from: "src/hooks/useAIChat.ts"
      to: "src/hooks/* extracted helpers"
      via: "decomposition into single-responsibility units"
      pattern: "import"
---

<objective>
Close the remaining size-policy gap by refactoring oversized functions and enforcing project-wide architecture fitness checks for the 50-line function cap.

Purpose: Convert the 50-line policy from guidance into enforceable guardrails and remove current hotspots that violate it.
Output: Refactored core hook/transport functions and lint/CI rules that block future function-size regressions.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02.2-stabilization-and-refactor/02.2-CONTEXT.md
@.planning/phases/02.2-stabilization-and-refactor/02.2-VERIFICATION.md
@.planning/phases/02.2-stabilization-and-refactor/02.2-09-SUMMARY.md
@.planning/phases/02.2-stabilization-and-refactor/02.2-10-SUMMARY.md

## Gap Context

Verification confirms component line counts are now compliant, but TECH-14 remains blocked because function-size enforcement is relaxed to 80 lines and scoped narrowly. Known offenders include `useAIChat`, `useConversations`, and `webllm-transport` send flow.

</context>

<tasks>

<task type="auto">
  <name>Decompose oversized hook and transport functions into <=50-line units</name>
  <files>src/hooks/useAIChat.ts, src/hooks/useConversations.ts, src/lib/ai/webllm-transport.ts, src/hooks/*, src/lib/ai/*</files>
  <action>
    Refactor identified hotspots while preserving behavior:

    1. Extract large orchestration blocks into focused helpers (validation, signal setup, retry handling, persistence write, message mapping).
    2. Keep each function <= 50 lines and single-responsibility, including extracted helpers.
    3. Preserve existing cancellation, OCC/idempotency, and Result/AppError semantics established in prior plans.
    4. Avoid introducing circular dependencies; prefer local helper modules colocated with the owning domain.

    This is architectural decomposition only, not feature work.
  </action>
  <verify>npm run lint && npm run type-check</verify>
  <done>All targeted hotspot functions are <= 50 lines with unchanged runtime behavior</done>
</task>

<task type="auto">
  <name>Enforce project-wide 50-line function fitness checks in lint configuration</name>
  <files>eslint.config.js, package.json</files>
  <action>
    Align lint enforcement with locked policy from CONTEXT.md:

    1. Update `max-lines-per-function` to 50 for TS/TSX source scope across `src/**` (not only specific files).
    2. Keep narrowly scoped, documented exceptions only where technically unavoidable (generated files, type declarations, explicit test fixtures).
    3. Ensure lint scripts in `package.json` run these checks in local/CI default paths.
    4. Remove relaxed 80-line overrides that currently mask violations.

    The rule should act as a hard gate for architecture regressions.
  </action>
  <verify>npm run lint</verify>
  <done>Linter enforces <=50 lines per function across application code and fails on new violations</done>
</task>

<task type="auto">
  <name>Add explicit architecture verification for size-policy compliance</name>
  <files>package.json, eslint.config.js</files>
  <action>
    Make compliance observable and repeatable:

    1. Add or update an architecture-check command that highlights function-size violations in CI-friendly output.
    2. Ensure default verification flow (`npm run lint`) includes this check so the gate cannot be skipped.
    3. Document rule intent directly in lint config comments only where non-obvious exceptions exist.

    Keep tooling simple and dependency-free.
  </action>
  <verify>npm run lint && npm run type-check</verify>
  <done>Size-policy compliance is automatically verified in standard developer and CI flows</done>
</task>

</tasks>

<verification>
- Run lint with function-size enforcement and confirm no violations in refactored hotspot files
- Introduce a temporary >50-line function locally (then remove) to confirm lint gate fails deterministically
- Run `npm run type-check` to ensure helper extraction preserves types and exports
</verification>

<success_criteria>
1. Function-size violations in `useAIChat`, `useConversations`, and `webllm-transport` are removed
2. `max-lines-per-function` policy is 50 and applied broadly to `src/**`
3. Lint/CI fails on any new function-size regression
4. TECH-14 gap is fully closable with objective lint evidence
</success_criteria>

<output>
After completion, create `.planning/phases/02.2-stabilization-and-refactor/02.2-11-SUMMARY.md`
</output>
