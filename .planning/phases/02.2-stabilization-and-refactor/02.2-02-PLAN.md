---
phase: 02.2-stabilization-and-refactor
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/store/chatStore.ts
  - src/hooks/useChat.ts
  - src/components/Chat/ChatInterface.tsx
  - src/components/Chat/MessageList.tsx
  - src/components/Chat/MessageInput.tsx
  - src/components/Sidebar/ConversationSidebar.tsx
autonomous: true
requirements:
  - TECH-03
  - TECH-04
must_haves:
  truths:
    - Legacy chatStore.ts is removed
    - Legacy useChat.ts is removed
    - Legacy Chat components are removed
    - No references to legacy stores remain in codebase
    - AI SDK UI is the single source of truth for chat state
  artifacts:
    - path: src/store/chatStore.ts
      provides: "File removed - no longer exists"
    - path: src/hooks/useChat.ts
      provides: "File removed - no longer exists"
    - path: src/components/Chat/ChatInterface.tsx
      provides: "File removed - superseded by AIChatInterface"
    - path: src/components/Chat/MessageList.tsx
      provides: "File removed - superseded by ai-elements"
    - path: src/components/Chat/MessageInput.tsx
      provides: "File removed - superseded by ai-elements"
    - path: src/components/Sidebar/ConversationSidebar.tsx
      provides: "File removed - superseded by AppSidebar"
  key_links:
    - from: "src/hooks/useConversations.ts"
      to: "AI SDK UI state"
      via: "Direct store access removed"
      pattern: "No chatStore.getState() calls"
---

<objective>
Remove legacy state management (chatStore.ts, useChat.ts) and legacy components to eliminate dual state confusion. AI SDK UI becomes the single source of truth.

Purpose: Eliminate architectural confusion from having two parallel chat systems. Legacy system is superseded by AI SDK UI implementation.
Output: Clean codebase with only AI SDK UI for chat state, no legacy files.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02.2-stabilization-and-refactor/02.2-CONTEXT.md
@.planning/audit/STABILITY_AUDIT.md

## Current Dual State Problem

From STABILITY_AUDIT.md Section 4.1:
- **Legacy:** chatStore.ts + useChat.ts - Custom Zustand implementation
- **Current:** useAIChat.ts + AI SDK UI - Vercel AI SDK

The legacy system is still imported and creates confusion.

## Files to Remove

From audit Section 1.4:
- src/components/Chat/ChatInterface.tsx - Legacy chat interface
- src/components/Chat/MessageList.tsx - Legacy message list
- src/components/Chat/MessageInput.tsx - Legacy input component
- src/components/Sidebar/ConversationSidebar.tsx - Legacy sidebar

Plus:
- src/store/chatStore.ts - Legacy Zustand store
- src/hooks/useChat.ts - Legacy hook

## Decisions from CONTEXT.md

- **Single source of truth:** AI SDK UI for chat state, Zustand for UI/app state only
- **Remove legacy:** Delete old chatStore.ts and useChat.ts after migration
</context>

<tasks>

<task type="auto">
  <name>Task 1: Identify and remove all legacy imports</name>
  <files>src/hooks/useConversations.ts, src/components/chat-layout/AppSidebar.tsx, src/routes/ChatDetailRoute.tsx</files>
  <action>
First, identify all files that import from legacy stores:

```bash
grep -r "from.*chatStore" src/ --include="*.ts" --include="*.tsx" | grep -v "node_modules"
grep -r "from.*useChat" src/ --include="*.ts" --include="*.tsx" | grep -v "node_modules"
grep -r "useChatStore" src/ --include="*.ts" --include="*.tsx" | grep -v "node_modules"
```

For each file found:

1. **src/hooks/useConversations.ts** - Uses chatStore for:
   - `chatStore.subscribe()` - Getting currentConversationId
   - `chatStore.getState().loadConversation()` - Loading conversation
   - `chatStore.getState().clearChat()` - Clearing chat

   Replace with:
   - Remove subscription, use props or local state for activeConversationId
   - Remove loadConversation/clearChat calls - navigation handles this

2. **Any other files** - Update to use AI SDK UI patterns or remove store access

Make minimal changes to remove chatStore dependencies while preserving functionality. The key insight: conversation loading happens via URL navigation (/chat/[id]), not via store actions.
  </action>
  <verify>grep -r "useChatStore\|from.*chatStore" src/ --include="*.ts" --include="*.tsx" | grep -v "node_modules" | wc -l | xargs test 0 -eq</verify>
  <done>No files import from chatStore - all legacy imports removed</done>
</task>

<task type="auto">
  <name>Task 2: Update useConversations to remove store dependency</name>
  <files>src/hooks/useConversations.ts</files>
  <action>
Refactor src/hooks/useConversations.ts to remove chatStore dependency:

Current problematic code:
```typescript
import { useChatStore, useChatMetrics } from "@/store/chatStore";

// Get the store instance for imperative operations
const chatStore = useChatStore;

// Subscribe to conversation ID changes
useEffect(() => {
  const unsubscribe = chatStore.subscribe((state) => {
    setActiveConversationId(state.currentConversationId);
  });
  return () => unsubscribe();
}, []);

// Later...
chatStore.getState().loadConversation(conversation);
chatStore.getState().clearChat();
```

Refactored version:
```typescript
import { useCallback, useEffect, useState } from "react";
import {
  getAllConversations,
  deleteConversation as deleteConversationStorage,
  updateConversationTitle,
} from "@/lib/storage/conversations";
import type { Conversation } from "@/types/index";

// Simple hook for conversation list management
export function useConversations() {
  const [conversations, setConversations] = useState<Conversation[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  // Load conversations on mount
  useEffect(() => {
    loadConversations();
  }, []);

  const loadConversations = useCallback(async () => {
    setIsLoading(true);
    setError(null);
    try {
      const all = await getAllConversations();
      setConversations(all);
    } catch (err) {
      setError(err instanceof Error ? err.message : "Failed to load");
    } finally {
      setIsLoading(false);
    }
  }, []);

  const deleteConversation = useCallback(async (id: string) => {
    try {
      await deleteConversationStorage(id);
      // Refresh list
      await loadConversations();
    } catch (err) {
      setError(err instanceof Error ? err.message : "Failed to delete");
      throw err;
    }
  }, [loadConversations]);

  const editTitle = useCallback(async (id: string, title: string) => {
    try {
      await updateConversationTitle(id, title);
      await loadConversations();
    } catch (err) {
      setError(err instanceof Error ? err.message : "Failed to update");
      throw err;
    }
  }, [loadConversations]);

  return {
    conversations,
    isLoading,
    error,
    deleteConversation,
    editTitle,
    refreshConversations: loadConversations,
  };
}
```

Key changes:
- Remove chatStore import
- Remove activeConversationId tracking (handled by URL now)
- Remove loadConversation (navigation handles this)
- Remove createNewConversation (navigation handles this)
- Remove performance monitoring (move to separate hook if needed)
- Keep only: conversation list, delete, edit title, refresh
  </action>
  <verify>grep -q "useChatStore\|chatStore" src/hooks/useConversations.ts && echo "FAIL: Still has store refs" || echo "PASS: Store refs removed"</verify>
  <done>useConversations no longer depends on chatStore - uses local state only</done>
</task>

<task type="auto">
  <name>Task 3: Delete legacy store and hook files</name>
  <files>src/store/chatStore.ts, src/hooks/useChat.ts</files>
  <action>
Delete the legacy files:

1. Delete src/store/chatStore.ts
2. Delete src/hooks/useChat.ts

These are no longer needed as AI SDK UI handles all chat state.

Verify no other files import these before deleting:
```bash
grep -r "from.*chatStore\|from.*useChat" src/ --include="*.ts" --include="*.tsx"
```

Should return no results (or only results from files we've already fixed).
  </action>
  <verify>test ! -f src/store/chatStore.ts && test ! -f src/hooks/useChat.ts && echo "PASS: Legacy files deleted"</verify>
  <done>chatStore.ts and useChat.ts deleted</done>
</task>

<task type="auto">
  <name>Task 4: Delete legacy component files</name>
  <files>src/components/Chat/ChatInterface.tsx, src/components/Chat/MessageList.tsx, src/components/Chat/MessageInput.tsx, src/components/Sidebar/ConversationSidebar.tsx</files>
  <action>
Delete the legacy component files that are superseded by AI SDK UI components:

1. Delete src/components/Chat/ChatInterface.tsx
   - Superseded by: src/components/Chat/AIChatInterface.tsx

2. Delete src/components/Chat/MessageList.tsx
   - Superseded by: ai-elements conversation components

3. Delete src/components/Chat/MessageInput.tsx
   - Superseded by: ai-elements prompt-input component

4. Delete src/components/Sidebar/ConversationSidebar.tsx
   - Superseded by: src/components/chat-layout/AppSidebar.tsx

Verify no imports remain:
```bash
grep -r "from.*ChatInterface\|from.*MessageList\|from.*MessageInput\|from.*ConversationSidebar" src/ --include="*.tsx" | grep -v "AIChatInterface"
```

Note: Keep these Chat/ components (they're still used):
- AIChatInterface.tsx (current implementation)
- MessageBubble.tsx (used for rendering)
- MarkdownMessage.tsx (used for rendering)
- CodeBlock.tsx (used for rendering)
- StreamingIndicator.tsx (used for UI)
- ChatToolbar.tsx (used for actions)
  </action>
  <verify>test ! -f src/components/Chat/ChatInterface.tsx && test ! -f src/components/Chat/MessageList.tsx && test ! -f src/components/Chat/MessageInput.tsx && test ! -f src/components/Sidebar/ConversationSidebar.tsx && echo "PASS: Legacy components deleted"</verify>
  <done>All legacy component files deleted</done>
</task>

</tasks>

<verification>
- No imports from chatStore or useChat anywhere in codebase
- useConversations uses local state only
- Legacy component files do not exist
- TypeScript compilation passes
- App still runs (AI SDK UI components work)
</verification>

<success_criteria>
- chatStore.ts deleted
- useChat.ts deleted
- Legacy Chat components deleted (ChatInterface, MessageList, MessageInput, ConversationSidebar)
- useConversations refactored without store dependency
- No TypeScript errors from missing imports
- AI SDK UI remains functional
</success_criteria>

<output>
After completion, create `.planning/phases/02.2-stabilization-and-refactor/02.2-02-SUMMARY.md`
</output>
