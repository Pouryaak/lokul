---
phase: 02.2-stabilization-and-refactor
type: gap-research
status: ready-for-gap-planning
created: 2026-02-18
updated: 2026-02-18
scope: model-engine-and-reliability
---

# Phase 02.2 Gap Closure: Industry Best-Practice Research (Model Engine)

This document translates external reliability standards into concrete gap-closure work for Lokul's model engine and chat reliability path.

## Sources Reviewed

1. AWS Builders' Library - Timeouts, retries, and backoff with jitter
   - https://aws.amazon.com/builders-library/timeouts-retries-and-backoff-with-jitter/
2. Google SRE Book - Handling Overload
   - https://sre.google/sre-book/handling-overload/
3. MDN Web API - AbortController
   - https://developer.mozilla.org/en-US/docs/Web/API/AbortController
4. Martin Fowler - Circuit Breaker
   - https://martinfowler.com/bliki/CircuitBreaker.html
5. web.dev - IndexedDB app-state best practices
   - https://web.dev/indexeddb-best-practices/
6. Stripe API docs - Idempotent requests
   - https://docs.stripe.com/api/idempotent_requests

## Current vs Industry Target (Model Engine)

| Capability | Industry Target | Current State | Gap |
|---|---|---|---|
| Load deduplication | Single in-flight request per model, suppress stale completions | Implemented (`ModelEngine` token + in-flight dedup) | Mostly covered |
| Retry policy | Capped exponential backoff + jitter + bounded retry budget | No explicit retry strategy in engine/store | Missing |
| Cancellation | Propagated `AbortSignal` across all async boundaries with deterministic cleanup | Generation abort implemented; broader async stack only partial | Missing |
| Idempotent writes | Safe retries for side-effecting writes (operation keys / conflict-safe semantics) | Plain `put()` writes without idempotency/OCC | Missing |
| Overload control | Retry budget, load-shedding/degraded mode, avoid retry storms | No retry budget/circuit breaker state | Missing |
| Circuit breaker | Open/half-open/closed for repeated failures; cooldown; monitored transitions | Error state exists; no breaker modes | Missing |
| Observability | Structured metrics/events for state transitions, retries, cancels, failures | DEV logs only, limited metrics | Missing |
| Data durability safety | Handle write failures, stale data, and schema drift defensively | Basic try/catch only | Partial |
| Testing rigor | State-machine, race, and fault-injection tests | Limited integration coverage for engine failure paths | Missing |

## Industry-Level Requirements for Lokul Model Engine

### 1) Explicit Reliability State Machine

Extend `ModelLoadingState` beyond `idle/loading/ready/error` to include resilience states:

- `cooldown` (after repeated failures)
- `half_open` (single trial request)
- `degraded` (chat UI available with constrained behavior)

Acceptance criteria:

- No uncontrolled retry loops.
- Repeated init failures transition to `cooldown` with visible countdown.
- Exactly one trial load in `half_open` before returning to `ready` or `cooldown`.

### 2) Retry Safety and Backoff Discipline

Implement:

- Capped exponential backoff (`base`, `factor`, `maxDelay`).
- Full jitter randomized delay.
- Per-request retry budget (max attempts) and per-session retry ratio guard.
- Retry only on retryable errors (transport/timeouts/transient worker failures).

Acceptance criteria:

- Retries are bounded and observable.
- Non-retryable errors fail fast.
- Retry metrics are emitted (`attempt`, `delay`, `reason`, `exhausted`).

### 3) Idempotency + Optimistic Concurrency for Persistence

Implement conversation write protection:

- Add `version` (or monotonic revision) to `Conversation`.
- `saveConversation` accepts `expectedVersion` and fails on conflicts.
- Add operation idempotency key for write attempts with short cache window.

Acceptance criteria:

- Duplicate save attempts for same op key do not create divergent state.
- Stale writes are rejected and surfaced as typed conflict errors.
- UI path handles conflict by refresh + merge/retry strategy.

### 4) End-to-End Cancellation Contract

Adopt `AbortSignal` threading as API surface:

- `modelEngine.loadModel(modelId, signal?)`
- storage operations that can be long-running accept `signal?`
- route transitions cancel obsolete operations immediately

Acceptance criteria:

- No leaked listeners/controllers after cancellation.
- Cancellation reasons are classified and user-safe (`user_stop`, `route_change`, `shutdown`, `model_switch`).

### 5) Circuit Breaker for Model Initialization

Introduce breaker around initialize path:

- Trip when transient failures exceed threshold in rolling window.
- Open state short-circuits immediate attempts.
- Half-open probes a single trial after cooldown.

Acceptance criteria:

- Repeated failures do not thrash worker creation/termination.
- Breaker transitions are logged as structured events.

### 6) Observability Baseline (Local-First Friendly)

Add local metrics/events (no remote analytics required):

- Model load latency histogram (`cold_start`, `warm_start`)
- Init failure counts by code/classification
- Retry attempts and budget exhaustion
- Cancel counts by reason
- State transition log (`from`, `to`, `timestamp`, `modelId`)

Acceptance criteria:

- Debug panels can render engine reliability timeline from local metrics.
- Every user-facing error maps to an internal error code.

### 7) Fault-Injection and State-Machine Tests

Add tests for:

- Duplicate concurrent `loadModel()` calls.
- Rapid model switching under load.
- Worker terminate during init.
- Retry budget exhaustion.
- Circuit breaker open/half-open/closed transitions.
- Persistence OCC conflicts and idempotency key replay.

Acceptance criteria:

- Deterministic tests assert state transitions, not just side effects.
- No flaky async tests under repeated runs.

## Gap Plans to Create (Recommended)

1. **02.2-G1 model-engine-reliability-state-machine**
   - Add cooldown/half-open/degraded states + transition guards.
2. **02.2-G2 retry-budget-backoff-jitter**
   - Implement bounded retries with jitter and retry classification.
3. **02.2-G3 persistence-idempotency-occ**
   - Add versioning, conflict-safe writes, and idempotency keys.
4. **02.2-G4 abort-signal-propagation**
   - Thread cancellation contract through route->engine->storage.
5. **02.2-G5 observability-and-fault-tests**
   - Add local telemetry model and resilience/fault-injection tests.

## Immediate File Targets

- `src/lib/ai/model-engine.ts`
- `src/lib/ai/inference.ts`
- `src/lib/storage/conversations.ts`
- `src/hooks/useAIChat.ts`
- `src/store/modelStore.ts`
- `src/types/index.ts` (conversation versioning and error code types)
- `src/lib/utils/errors.ts` (retryability classification)
- tests under `src/lib/ai/` and `src/lib/storage/`

## Practical Quality Bar (Industry-Ready for This Product)

Lokul should be considered industry-standard for model lifecycle reliability when all are true:

- Model init can fail repeatedly without user-visible loops or app instability.
- Retries are bounded, jittered, and measurable.
- Persistence is conflict-safe and idempotent.
- Cancellation is consistent and leak-free.
- Every failure path has deterministic recovery behavior.
- Reliability behavior is covered by automated state-transition tests.
