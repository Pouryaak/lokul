---
phase: 02.2-stabilization-and-refactor
plan: 07
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/index.ts
  - src/lib/storage/conversations.ts
  - src/lib/utils/errors.ts
  - src/hooks/useAIChat.ts
autonomous: true
gap_closure: true
requirements:
  - TECH-11
must_haves:
  truths:
    - "Conversation persistence rejects stale writes instead of silently overwriting newer state"
    - "Duplicate save attempts with the same idempotency key resolve to one durable outcome"
    - "Chat persistence can recover from version conflicts with a deterministic retry/merge path"
  artifacts:
    - path: "src/types/index.ts"
      provides: "Versioned conversation and persistence conflict types"
      contains: "version field and compare-and-swap write contract"
    - path: "src/lib/storage/conversations.ts"
      provides: "Compare-and-swap save with idempotency window"
      exports: ["saveConversation", "saveConversationWithVersion"]
    - path: "src/hooks/useAIChat.ts"
      provides: "Conflict-aware persistence retry/merge flow"
      contains: "conflict detection and caller-level recovery"
  key_links:
    - from: "src/hooks/useAIChat.ts"
      to: "src/lib/storage/conversations.ts"
      via: "versioned save API with expectedVersion + idempotencyKey"
      pattern: "saveConversationWithVersion"
---

<objective>
Close the persistence race-condition gap by introducing optimistic concurrency control (OCC), explicit conflict errors, and idempotency-safe writes.

Purpose: Make IndexedDB persistence deterministic under rapid updates, retries, and navigation churn.
Output: Versioned conversation writes and conflict-aware persistence orchestration in the chat path.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02.2-stabilization-and-refactor/02.2-CONTEXT.md
@.planning/phases/02.2-stabilization-and-refactor/02.2-VERIFICATION.md
@.planning/phases/02.2-stabilization-and-refactor/02.2-GAPS-INDUSTRY-RESEARCH.md

## Gap Context

Verification reported that persistence currently uses plain `put()` with no stale-write rejection or conflict surface. This plan implements the locked decision from CONTEXT.md: "Race protection: Optimistic locking for storage operations."

</context>

<tasks>

<task type="auto">
  <name>Add versioned persistence contracts and typed conflict errors</name>
  <files>src/types/index.ts, src/lib/utils/errors.ts</files>
  <action>
    Introduce explicit persistence concurrency contracts:

    1. Extend conversation/storage types with a monotonic `version` field and save options carrying `expectedVersion`, `idempotencyKey`, and dedup-window metadata.
    2. Add typed conflict/idempotency error helpers in `errors.ts` (for example: `PERSISTENCE_CONFLICT`, `PERSISTENCE_IDEMPOTENT_REPLAY`) with stable error codes and user-safe messages.
    3. Ensure type exports are available through existing barrels so downstream hooks and storage modules can consume them without `any` fallbacks.

    Keep functions small (< 50 lines) by extracting error constructors and validation helpers.
  </action>
  <verify>npm run type-check</verify>
  <done>Type-safe contracts exist for expected-version writes and conflict/idempotency outcomes</done>
</task>

<task type="auto">
  <name>Implement compare-and-swap writes with short-lived idempotency dedup</name>
  <files>src/lib/storage/conversations.ts</files>
  <action>
    Replace blind upsert logic with OCC + idempotency semantics:

    1. Add a storage API that performs compare-and-swap writes (`expectedVersion` -> next write) inside a Dexie transaction.
    2. Reject stale writes with typed conflict errors that include current/version metadata needed for caller-level resolution.
    3. Add a short-lived in-memory idempotency cache keyed by `conversationId + idempotencyKey` so replayed retries return the same outcome without duplicate side effects.
    4. Keep existing `saveConversation` compatibility by delegating to the new API with explicit defaults.

    Preserve local-first constraints: no network and no server assumptions.
  </action>
  <verify>npm run test -- src/lib/storage 2>/dev/null || npm run type-check</verify>
  <done>Storage writes are conflict-safe and idempotent with explicit, typed failure modes</done>
</task>

<task type="auto">
  <name>Propagate conflict handling into debounced chat persistence</name>
  <files>src/hooks/useAIChat.ts</files>
  <action>
    Update chat persistence orchestration to use versioned writes:

    1. Generate deterministic idempotency keys per persistence attempt (conversation + logical update fingerprint).
    2. Pass `expectedVersion` and handle conflict errors by reloading latest conversation, reconciling message state, and retrying with bounded attempts.
    3. Keep debounce behavior, but ensure stale retries do not overwrite newer conversation state.
    4. Surface non-recoverable persistence failures through structured errors (no silent swallow).

    Respect existing UX: no new capabilities, only reliability hardening.
  </action>
  <verify>npm run lint && npm run type-check</verify>
  <done>Debounced persistence path handles OCC conflicts deterministically without data loss races</done>
</task>

</tasks>

<verification>
- Simulate concurrent writes for one conversation and confirm stale attempts are rejected
- Replay the same idempotency key and confirm duplicated persistence side effects are suppressed
- Validate chat persistence retries resolve conflicts without duplicate messages
- Run `npm run type-check` and `npm run lint`
</verification>

<success_criteria>
1. Conversation writes use expected-version compare-and-swap semantics
2. Conflict and idempotency replay paths return typed errors/results
3. useAIChat persistence handles conflicts with bounded retry/merge logic
4. No plain overwrite path remains for critical conversation persistence writes
</success_criteria>

<output>
After completion, create `.planning/phases/02.2-stabilization-and-refactor/02.2-07-SUMMARY.md`
</output>
