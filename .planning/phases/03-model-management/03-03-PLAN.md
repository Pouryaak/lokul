---
phase: 03-model-management
plan: 03
type: execute
wave: 2
depends_on:
  - 03-01
  - 03-02
files_modified:
  - src/store/conversationModelStore.ts
  - src/components/model/DownloadManager.tsx
  - src/components/model/InputModelSelector.tsx
  - src/components/Chat/AIChatInterface.tsx
  - src/components/Chat/ai-chat-parts.tsx
  - src/components/chat-layout/ChatLayout.tsx
  - src/lib/ai/model-engine.ts
  - src/lib/ai/inference.ts
  - src/store/modelStore.test.ts
autonomous: true
requirements:
  - MODEL-03
  - MODEL-04
  - MODEL-05
  - MODEL-06
  - MODEL-08
must_haves:
  truths:
    - "Selecting an undownloaded model starts background download and keeps chat usable."
    - "When download completes, auto-switch happens only if that model is still the active requested target."
    - "If user changes intent before completion, previous download completion does not force-switch active model."
    - "Successful auto-switch shows toast feedback and selector confirmation state."
  artifacts:
    - path: "src/store/conversationModelStore.ts"
      provides: "Queue worker and stale-request-safe completion guard"
    - path: "src/components/model/DownloadManager.tsx"
      provides: "Interactive state wiring for open/focus, retry, cancel, and progress updates"
    - path: "src/components/model/InputModelSelector.tsx"
      provides: "Selection events wired to orchestration APIs and confirmation highlighting"
    - path: "src/store/modelStore.test.ts"
      provides: "Automated assertions for queue sequencing and stale completion behavior"
  key_links:
    - from: "src/components/model/InputModelSelector.tsx"
      to: "src/store/conversationModelStore.ts"
      via: "requestModelSwitch action"
      pattern: "request.*Model"
    - from: "src/store/conversationModelStore.ts"
      to: "src/components/model/DownloadManager.tsx"
      via: "download lifecycle subscription"
      pattern: "Queued|Downloading|Compiling|Ready|Failed|Canceled"
    - from: "src/store/conversationModelStore.ts"
      to: "src/lib/ai/model-engine.ts"
      via: "serialized load/cancel execution"
      pattern: "loadModel|unload"
---

<objective>
Integrate model orchestration and UI surfaces into a complete non-blocking switching flow with deterministic queue behavior and stale-request-safe auto-switching.

Purpose: Deliver the full user-visible model management lifecycle without regressing Phase 2.2 reliability and route stability guardrails.
Output: End-to-end model request/download/switch UX with automated checks for queue and race-condition behavior.
</objective>

<execution_context>
@/Users/poak/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/poak/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-model-management/03-CONTEXT.md
@.planning/phases/03-model-management/03-RESEARCH.md
@.planning/phases/03-model-management/03-01-PLAN.md
@.planning/phases/03-model-management/03-02-PLAN.md
@src/store/conversationModelStore.ts
@src/components/model/DownloadManager.tsx
@src/components/model/InputModelSelector.tsx
@src/components/Chat/AIChatInterface.tsx
@src/lib/ai/model-engine.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire selector and manager to queue-driven orchestration</name>
  <files>src/store/conversationModelStore.ts, src/components/model/InputModelSelector.tsx, src/components/model/DownloadManager.tsx, src/components/Chat/AIChatInterface.tsx, src/components/Chat/ai-chat-parts.tsx, src/components/chat-layout/ChatLayout.tsx</files>
  <action>Connect selector actions to orchestration store APIs so selecting an undownloaded model enqueues download and opens/focuses Download Manager. Keep chat running on currently loaded model during download. On completion, auto-switch only when completion model still equals latest requested model for active conversation (per locked discretion). If user switched to another model in the meantime, mark completed model Ready without forcing activation.</action>
  <verify>npm run type-check && npm run lint</verify>
  <done>Download requests are queued one-by-one, manager opens automatically for undownloaded selections, and stale completion never overrides newer user intent.</done>
</task>

<task type="auto">
  <name>Task 2: Finalize feedback and cancellation/retry behavior</name>
  <files>src/components/model/DownloadManager.tsx, src/components/model/InputModelSelector.tsx, src/store/conversationModelStore.ts, src/lib/ai/model-engine.ts, src/lib/ai/inference.ts</files>
  <action>Implement cancel-confirm flow for active/queued download items, inline retry that re-enqueues failed items, and success feedback with both toast and selector visual confirmation. Ensure cancellation propagates through existing model engine/inference cancellation semantics from 02.2 and does not break in-flight chat generation controls.</action>
  <verify>npm run type-check && npm run test</verify>
  <done>Users can cancel with confirmation, retry failed items inline, and receive consistent auto-switch confirmation (toast + selector state) when target activation succeeds.</done>
</task>

<task type="auto">
  <name>Task 3: Add deterministic automated coverage for queue and race guards</name>
  <files>src/store/modelStore.test.ts</files>
  <action>Add or extend Vitest coverage for serialized queue execution, lifecycle transitions (Queued -> Downloading -> Compiling -> Ready / Failed / Canceled), stale auto-switch prevention when user changed target, and non-blocking behavior while download is active. Mock model engine boundaries rather than hitting real model downloads.</action>
  <verify>npm run test</verify>
  <done>Automated tests fail if queue order, stale-guard logic, or lifecycle transition handling regresses.</done>
</task>

</tasks>

<verification>
1. Start chat on conversation A, request an undownloaded model, and confirm chat remains usable while manager shows progress.
2. While model X downloads, switch requested model to Y; after X completes confirm active model stays Y target and X is marked Ready.
3. Trigger failure path and confirm inline Retry re-queues item and progresses through states.
4. Cancel queued/downloading item and confirm explicit Canceled state appears after confirmation.
</verification>

<success_criteria>
- End-to-end switching/downloading works without page reload or thread reset.
- Queue and stale-intent safeguards behave deterministically across rapid model changes.
- Users receive explicit lifecycle visibility and completion feedback through manager + selector + toast.
</success_criteria>

<output>
After completion, create `.planning/phases/03-model-management/03-model-management-03-SUMMARY.md`
</output>
