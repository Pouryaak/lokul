---
phase: 04-memory-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/storage/db.ts
  - src/lib/storage/memory.ts
  - src/lib/memory/types.ts
  - src/lib/memory/extraction.ts
  - src/lib/memory/storage-operations.ts
  - src/types/index.ts
autonomous: true
requirements:
  - MEM-01
  - MEM-02
must_haves:
  truths:
    - "Memory facts can be saved to and retrieved from IndexedDB"
    - "Database schema migrates to version 2 with memory table indexes"
    - "Fact extraction service can call the loaded LLM with structured JSON prompt"
    - "Duplicate facts are merged with confidence boost"
    - "Conflicting facts replace old facts with reset confidence"
  artifacts:
    - path: "src/lib/storage/db.ts"
      provides: "Dexie schema v2 with memory table and indexes"
      contains: "id, category, lastSeen, confidence, lastSeenConversationId"
    - path: "src/lib/storage/memory.ts"
      provides: "Memory CRUD operations with Result<T,E> error handling"
      exports: ["saveMemoryFact", "getMemoryFacts", "deleteMemoryFact", "updateMemoryFact"]
    - path: "src/lib/memory/types.ts"
      provides: "Memory-specific type definitions"
      exports: ["MemoryFact", "ExtractedFact", "MemoryCategory"]
    - path: "src/lib/memory/extraction.ts"
      provides: "LLM-based fact extraction with JSON output"
      exports: ["extractFacts", "createExtractionPrompt"]
    - path: "src/lib/memory/storage-operations.ts"
      provides: "Duplicate detection and conflict resolution"
      exports: ["mergeDuplicateFact", "resolveConflictingFact"]
  key_links:
    - from: "src/lib/memory/extraction.ts"
      to: "WebLLM engine"
      via: "engine.chat.completions.create"
      pattern: "extraction prompt with JSON format"
    - from: "src/lib/storage/memory.ts"
      to: "src/lib/storage/db.ts"
      via: "Dexie table operations"
      pattern: "db.memory.put|get|delete"
---

<objective>
Build the foundation of the memory system: Dexie schema migration for the memory table, CRUD storage operations with Result<T,E> error handling, and the LLM-based fact extraction service that identifies and extracts user facts from conversations.

Purpose: Without reliable storage and extraction, the memory system cannot function. This plan establishes the data layer and the core intelligence for identifying what facts to remember.
Output: Database schema v2, memory storage module, extraction service, and type definitions.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-memory-system/04-CONTEXT.md
@.planning/phases/04-memory-system/04-RESEARCH.md

# Established patterns from previous phases
@src/lib/storage/db.ts
@src/lib/storage/conversations.ts
@src/types/result.ts
@src/lib/utils/errors.ts
@src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Dexie Schema Migration and Memory Types</name>
  <files>
    src/lib/storage/db.ts
    src/lib/memory/types.ts
    src/types/index.ts
  </files>
  <action>
    1. Update src/lib/storage/db.ts to add schema version 2:
       - Add DB_VERSION = 2 constant
       - Add version 2 migration with .upgrade() callback
       - Update memory table indexes to: "id, category, lastSeen, confidence, lastSeenConversationId"
       - Keep version 1 definition for existing users migrating up

    2. Create src/lib/memory/types.ts with MemoryFact interface matching CONTEXT.md:
       ```typescript
       export type MemoryCategory = "identity" | "preference" | "project";

       export interface MemoryFact {
         id: string;
         fact: string;
         category: MemoryCategory;
         confidence: number; // 0.0 - 1.0
         mentionCount: number;
         firstSeen: number;
         lastSeen: number;
         lastSeenConversationId: string;
         pinned: boolean;
         updatesFactId?: string;
       }

       export interface ExtractedFact {
         fact: string;
         category: MemoryCategory;
         confidence: number;
         updatesPrevious: boolean;
       }
       ```

    3. Update src/types/index.ts MemoryFact interface to match the new structure (it's currently a simpler version).
       Keep backward compatibility if possible, or update all references.

    4. Add memory error codes to src/lib/utils/errors.ts:
       - "MEMORY_ERROR"
       - "MEMORY_EXTRACTION_FAILED"
       - "MEMORY_QUOTA_EXCEEDED"

    Follow the existing error pattern with createError() helper.
  </action>
  <verify>
    - TypeScript compiles without errors: npm run type-check
    - Database opens successfully in browser devtools
    - Memory table appears in IndexedDB with correct indexes
  </verify>
  <done>
    - Schema v2 migration exists with proper upgrade path
    - MemoryFact type has all required fields from CONTEXT.md
    - Error codes added for memory operations
    - No TypeScript errors in modified files
  </done>
</task>

<task type="auto">
  <name>Task 2: Memory Storage CRUD Operations</name>
  <files>
    src/lib/storage/memory.ts
  </files>
  <action>
    Create src/lib/storage/memory.ts following the pattern from src/lib/storage/conversations.ts:

    1. Import patterns to follow:
       - Use Result<T,E> from @/types/result
       - Use db from ./db
       - Use error utilities from @/lib/utils/errors
       - Import MemoryFact from @/lib/memory/types

    2. Implement these functions with Result<T,E> return types:

       ```typescript
       // Save a new memory fact (handles duplicates via merge)
       export async function saveMemoryFact(
         fact: Omit<MemoryFact, "id">,
         options?: { signal?: AbortSignal }
       ): Promise<Result<MemoryFact, AppError>>

       // Get all memory facts, optionally filtered by category
       export async function getMemoryFacts(
         options?: { category?: MemoryCategory; signal?: AbortSignal }
       ): Promise<Result<MemoryFact[], AppError>>

       // Get a single memory fact by ID
       export async function getMemoryFact(
         id: string,
         options?: { signal?: AbortSignal }
       ): Promise<Result<MemoryFact | undefined, AppError>>

       // Update an existing memory fact
       export async function updateMemoryFact(
         id: string,
         updates: Partial<Omit<MemoryFact, "id">>,
         options?: { signal?: AbortSignal }
       ): Promise<Result<MemoryFact, AppError>>

       // Delete a memory fact
       export async function deleteMemoryFact(
         id: string,
         options?: { signal?: AbortSignal }
       ): Promise<Result<void, AppError>>

       // Clear all memory facts (for "Clear All" feature)
       export async function clearAllMemory(
         options?: { signal?: AbortSignal }
       ): Promise<Result<number, AppError>> // Returns count deleted
       ```

    3. Implement duplicate detection in saveMemoryFact:
       - Query existing facts with similar content (exact match on normalized fact text)
       - If duplicate found: merge instead of creating new
       - Use Dexie transaction for atomic read-then-write

    4. Implement these helper functions:
       ```typescript
       // Check if two facts are duplicates (exact match on normalized text)
       function isDuplicate(fact1: string, fact2: string): boolean

       // Normalize fact text for comparison (lowercase, trim whitespace)
       function normalizeFactText(text: string): string

       // Merge duplicate facts (boost confidence, increment mentionCount)
       function mergeFacts(existing: MemoryFact, newFact: Omit<MemoryFact, "id">): MemoryFact
       ```

    5. Follow error handling patterns:
       - Use assertNotAborted() pattern from conversations.ts
       - Wrap Dexie errors with storageError()
       - Return err() for failures, ok() for successes

    6. Add debug logging in DEV mode like conversations.ts does.
  </action>
  <verify>
    - All functions have proper Result<T,E> return types
    - TypeScript compiles without errors
    - Functions can be imported and called (test in browser console)
  </verify>
  <done>
    - saveMemoryFact, getMemoryFacts, getMemoryFact, updateMemoryFact, deleteMemoryFact, clearAllMemory all implemented
    - Duplicate detection works (same fact text merges instead of creates new)
    - Result<T,E> pattern used throughout
    - Proper abort signal handling
  </done>
</task>

<task type="auto">
  <name>Task 3: Fact Extraction Service</name>
  <files>
    src/lib/memory/extraction.ts
    src/lib/memory/storage-operations.ts
  </files>
  <action>
    1. Create src/lib/memory/extraction.ts:

       ```typescript
       // Main extraction function - calls LLM with structured prompt
       export async function extractFacts(
         engine: MLCEngineInterface,
         messages: Message[],
         options?: {
           minConfidence?: number; // default 0.75
           signal?: AbortSignal;
         }
       ): Promise<Result<ExtractedFact[], AppError>>
       ```

       Implementation details:
       - Build extraction prompt using createExtractionPrompt(messages)
       - Call engine.chat.completions.create with:
         - temperature: 0.1 (low for consistent output)
         - max_tokens: 500
         - response_format: { type: "json_object" } if supported
       - Parse JSON response and validate with Zod or manual validation
       - Filter facts by minConfidence (default 0.75)
       - Return ok(extractedFacts) or err(memoryExtractionError())

       ```typescript
       // Build the extraction prompt
       export function createExtractionPrompt(messages: Message[]): Message[]
       ```

       Prompt template (from CONTEXT.md):
       ```
       Extract memorable facts from this conversation.
       Return ONLY a JSON object with format: {"facts": [{"fact": "...", "category": "identity|preference|project", "confidence": 0.0-1.0, "updates_previous": false}]}

       Rules:
       - Only include high-confidence facts stated directly by the user
       - "identity": personal info (name, location, job)
       - "preference": likes/dislikes, communication style
       - "project": current work, goals, tasks
       - Set "updates_previous" to true if this contradicts an earlier fact
       ```

       Include last 10 messages for context (not entire conversation).

    2. Create src/lib/memory/storage-operations.ts for conflict resolution:

       ```typescript
       // Handle duplicate detection with merge
       export async function mergeDuplicateFact(
         existing: MemoryFact,
         newFact: ExtractedFact,
         conversationId: string
       ): Promise<Result<MemoryFact, AppError>>
       ```
       Logic:
       - confidence = Math.min(1.0, existing.confidence + 0.15)
       - mentionCount += 1
       - lastSeen = Date.now()
       - lastSeenConversationId = conversationId

       ```typescript
       // Handle conflicting facts (replacement)
       export async function resolveConflictingFact(
         existingId: string,
         newFact: ExtractedFact,
         conversationId: string
       ): Promise<Result<MemoryFact, AppError>>
       ```
       Logic:
       - Delete existing fact
       - Create new fact with baseline confidence (0.75)
       - Set updatesFactId to track lineage

       ```typescript
       // Process extracted facts - handles duplicates and conflicts
       export async function processExtractedFacts(
         facts: ExtractedFact[],
         conversationId: string,
         options?: { signal?: AbortSignal }
       ): Promise<Result<MemoryFact[], AppError>>
       ```
       Logic:
       - For each extracted fact:
         - If updatesPrevious: find and resolve conflicting fact
         - Else: check for duplicates, merge or create new
       - Return array of saved/merged facts

    3. Add error type to errors.ts:
       ```typescript
       export function memoryExtractionError(message: string, cause?: unknown): AppError
       ```

    4. Handle JSON parsing failures gracefully:
       - If JSON is malformed, return empty array (not error)
       - Log warning in DEV mode
       - Don't block conversation flow on extraction failure
  </action>
  <verify>
    - extractFacts function signature matches expected usage
    - createExtractionPrompt returns properly formatted messages
    - processExtractedFacts handles both duplicates and conflicts
    - TypeScript compiles without errors
  </verify>
  <done>
    - extractFacts calls LLM with structured JSON prompt
    - createExtractionPrompt builds proper extraction messages
    - processExtractedFacts saves facts with duplicate/conflict handling
    - JSON parsing is defensive (graceful degradation)
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Run type-check: npm run type-check
2. Verify no lint errors: npm run lint
3. Check that MemoryFact type is consistent across all files
4. Confirm error codes are registered in errors.ts
</verification>

<success_criteria>
- Database schema successfully migrates to v2 with memory table
- Memory CRUD operations work with Result<T,E> error handling
- Fact extraction service can call LLM and parse JSON responses
- Duplicate detection merges facts with confidence boost
- Conflict resolution replaces contradictory facts
</success_criteria>

<output>
After completion, create `.planning/phases/04-memory-system/04-01-SUMMARY.md`
</output>
