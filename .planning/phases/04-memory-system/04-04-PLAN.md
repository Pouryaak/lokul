---
phase: 04-memory-system
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/Chat/AIChatInterface.tsx
  - src/hooks/useMemoryExtraction.ts
  - src/lib/memory/extraction.ts
  - src/lib/memory/storage-operations.ts
autonomous: true
requirements:
  - MEM-01
  - MEM-02
gap_closure: true
must_haves:
  truths:
    - "Automatic extraction runs from the rendered chat flow every 5 messages"
    - "End-of-session extraction runs on visibility/unmount without unreliable async beforeunload behavior"
    - "Extraction pipeline safely no-ops on too-short message history and keeps parsing/error handling deterministic"
  artifacts:
    - path: "src/components/Chat/AIChatInterface.tsx"
      provides: "Active chat integration point that invokes memory extraction hook with live conversation state"
      contains: "useMemoryExtraction(conversationId"
    - path: "src/hooks/useMemoryExtraction.ts"
      provides: "Stable extraction lifecycle with low listener churn and deterministic cleanup behavior"
      exports: ["useMemoryExtraction"]
    - path: "src/lib/memory/extraction.ts"
      provides: "Extraction guardrails for short history and strict error typing without unnecessary casting"
      exports: ["extractFacts", "createExtractionPrompt"]
    - path: "src/lib/memory/storage-operations.ts"
      provides: "Clear conflict candidate selection naming/commenting around updates_previous handling"
      exports: ["processExtractedFacts"]
  key_links:
    - from: "src/components/Chat/AIChatInterface.tsx"
      to: "src/hooks/useMemoryExtraction.ts"
      via: "hook invocation with live messages and conversationId"
      pattern: "useMemoryExtraction\(conversationId"
    - from: "src/hooks/useMemoryExtraction.ts"
      to: "src/lib/memory/extraction.ts"
      via: "extractFacts in scheduled trigger"
      pattern: "extractFacts\(engine"
    - from: "src/hooks/useMemoryExtraction.ts"
      to: "src/lib/memory/storage-operations.ts"
      via: "processExtractedFacts persistence call"
      pattern: "processExtractedFacts\("
---

<objective>
Close the extraction wiring gap so memory growth actually happens during normal chats, while hardening extraction lifecycle behavior for long-running sessions.

Purpose: MEM-01 is blocked unless extraction runs from the real chat UI and survives realistic lifecycle events without racey listener behavior.
Output: Active chat extraction wiring, robust extraction hook lifecycle, and safer extraction/storage-operation cleanup.
</objective>

<execution_context>
@/Users/poak/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/poak/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-memory-system/04-CONTEXT.md
@.planning/phases/04-memory-system/04-VERIFICATION.md
@.planning/phases/04-memory-system/04-02-SUMMARY.md
@src/components/Chat/AIChatInterface.tsx
@src/hooks/useMemoryExtraction.ts
@src/lib/memory/extraction.ts
@src/lib/memory/storage-operations.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire extraction into active chat runtime</name>
  <files>
    src/components/Chat/AIChatInterface.tsx
    src/hooks/useMemoryExtraction.ts
  </files>
  <action>
    Add useMemoryExtraction to the rendered chat surface in src/components/Chat/AIChatInterface.tsx so it receives the real conversationId and live messages from useAIChat. Keep trigger cadence aligned with locked decisions: periodic every 5 messages plus end-of-session behavior. Ensure message mapping passed to the hook is stable and compatible with extraction expectations (role/content), and avoid introducing duplicate extraction triggers for the same message window.
  </action>
  <verify>
    - npm run type-check
    - Confirm `useMemoryExtraction` is referenced from AIChatInterface via code search
    - In local app, send 5+ user messages and verify new memory facts appear after extraction completes
  </verify>
  <done>
    - Extraction hook is invoked from the active chat component
    - Hook receives real conversationId and current chat messages
    - Auto extraction occurs during normal chat use without manual trigger
  </done>
</task>

<task type="auto">
  <name>Task 2: Harden extraction hook lifecycle and cleanup ordering</name>
  <files>
    src/hooks/useMemoryExtraction.ts
  </files>
  <action>
    Refactor the hook to reduce listener churn caused by callback dependencies on `messages` while preserving fresh data access (use refs for latest messages/conversationId). Remove ineffective async `beforeunload` extraction path; keep visibility/unmount as primary end-of-session signals per locked decision. Fix cleanup ordering so unmount extraction attempt runs before teardown that would cancel scheduled work, and ensure timers/listeners are cleaned up deterministically.
  </action>
  <verify>
    - npm run type-check
    - Validate add/remove listener counts remain stable across message updates (DEV inspection)
    - Navigate away from chat and confirm end-of-session extraction still persists facts when eligible
  </verify>
  <done>
    - No per-message listener re-registration churn
    - Unmount/session-close extraction path runs reliably
    - Hook cleanup leaves no dangling timers or event listeners
  </done>
</task>

<task type="auto">
  <name>Task 3: Clean extraction edge cases and conflict-selection readability</name>
  <files>
    src/lib/memory/extraction.ts
    src/lib/memory/storage-operations.ts
  </files>
  <action>
    In extraction.ts, remove the unnecessary `as MemoryError` cast and simplify error return paths with existing AppError typing. Add an early return when message history is too short to extract meaningful facts, and apply dead-code simplification where behavior stays identical. In storage-operations.ts, clarify naming/commenting around conflict candidate selection (`updates_previous`) so intent is explicit without changing conflict semantics.
  </action>
  <verify>
    - npm run type-check
    - Unit-level call to extractFacts with <2 messages returns ok([])
    - Conflict handling behavior remains unchanged for duplicate vs updates_previous inputs
  </verify>
  <done>
    - Extraction short-history guard is present and tested
    - Unnecessary cast removed with no type regressions
    - Conflict-candidate naming/commenting is clearer and behavior-equivalent
  </done>
</task>

</tasks>

<verification>
1. Validate extraction hook is wired from active chat and no longer orphaned.
2. Run an end-to-end 5-message extraction scenario and verify persisted facts in Memory Panel.
3. Confirm route change/tab hide still triggers final extraction without beforeunload async dependence.
</verification>

<success_criteria>
- MEM-01 extraction trigger truth is satisfied in rendered chat flow.
- Extraction lifecycle is stable under long chats and component unmounts.
- Extraction and conflict-processing code is simpler and safer without behavior regressions.
</success_criteria>

<output>
After completion, create `.planning/phases/04-memory-system/04-04-SUMMARY.md`
</output>
