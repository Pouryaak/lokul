---
phase: 04-memory-system
plan: 06
type: execute
wave: 2
depends_on: ["04-05"]
files_modified:
  - src/hooks/useMemory.ts
  - src/components/memory/MemoryPanel.tsx
autonomous: true
requirements:
  - MEM-05
  - MEM-06
  - MEM-07
gap_closure: true
must_haves:
  truths:
    - "Clear-all undo action reliably cancels pending wipe and preserves facts"
    - "Undo click works on first interaction without requiring a second click due to panel dismissal"
    - "Memory panel manual-entry defaults are explicit and consistent with stored category behavior"
  artifacts:
    - path: "src/hooks/useMemory.ts"
      provides: "Reliable clear-all undo lifecycle and shared pin-limit constant usage"
      exports: ["useMemory"]
    - path: "src/components/memory/MemoryPanel.tsx"
      provides: "Sheet/toast interaction handling that does not swallow first undo click"
      exports: ["MemoryPanel"]
  key_links:
    - from: "src/components/memory/MemoryPanel.tsx"
      to: "src/hooks/useMemory.ts"
      via: "clearAllFacts + undo action flow"
      pattern: "clearAllFacts|Undo"
    - from: "src/hooks/useMemory.ts"
      to: "src/lib/memory/eviction.ts"
      via: "shared MAX_PINNED constant import"
      pattern: "MEMORY_LIMITS"
---

<objective>
Resolve user-facing memory panel regressions around clear-all undo reliability and interaction quality, plus small clarity improvements in manual-memory behavior.

Purpose: Memory controls must feel trustworthy; undo affordances that fail or require repeated clicks break MEM-07 confidence.
Output: Functional clear-all undo, first-click undo UX fix, and clearer manual memory defaults.
</objective>

<execution_context>
@/Users/poak/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/poak/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-memory-system/04-CONTEXT.md
@.planning/phases/04-memory-system/04-VERIFICATION.md
@.planning/phases/04-memory-system/04-03-SUMMARY.md
@src/hooks/useMemory.ts
@src/components/memory/MemoryPanel.tsx
@src/lib/memory/eviction.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix clear-all undo reliability in memory hook</name>
  <files>
    src/hooks/useMemory.ts
  </files>
  <action>
    Refine clear-all state lifecycle so the Undo action always cancels pending deletion and restores visible facts deterministically. Preserve optimistic-clear UX but ensure timer cancellation and state restoration are robust even when panel focus changes. Use exported shared limit constants from eviction.ts (from 04-05) instead of local duplicated max-pin literals to remove drift risk.
  </action>
  <verify>
    - npm run type-check
    - Trigger clear-all then click Undo within toast window; verify facts remain and no wipe occurs
    - Pin limit enforcement still caps at configured value via shared constant
  </verify>
  <done>
    - Undo for clear-all performs a real cancellation of pending wipe
    - No duplicate hardcoded pin-limit value remains in useMemory
    - Hook behavior is stable across repeated clear/undo cycles
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix first-click undo UX and clarify manual category default</name>
  <files>
    src/components/memory/MemoryPanel.tsx
  </files>
  <action>
    Update sheet interaction handling so clicking Undo toast does not first dismiss the Memory Panel (single click should execute undo action immediately). Use shadcn Sheet interaction hooks to ignore outside-interaction closure when the target is a toast action. Also make manual-add default category intent explicit in panel code (constant or inline clarification) so category behavior is self-documenting and consistent.
  </action>
  <verify>
    - npm run type-check
    - Clear-all then click Undo once; panel stays stable and undo executes on first click
    - Manual add path still creates facts in intended default category with existing confidence behavior
  </verify>
  <done>
    - First click on Undo triggers undo directly (no extra click needed)
    - Memory panel no longer closes due to toast interaction side effects
    - Manual default category behavior is clearly documented in code
  </done>
</task>

</tasks>

<verification>
1. Perform full clear-all flow: clear -> undo -> verify facts preserved.
2. Verify undo click path works with panel open and does not dismiss panel first.
3. Confirm manual fact add still appears in expected category section.
</verification>

<success_criteria>
- MEM-07 clear-all undo is functionally reliable and user-trustworthy.
- Memory panel interactions no longer require double-click behavior for undo.
- UI behavior for viewing/editing/clearing remains consistent with existing memory controls.
</success_criteria>

<output>
After completion, create `.planning/phases/04-memory-system/04-06-SUMMARY.md`
</output>
