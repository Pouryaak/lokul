---
phase: 04-memory-system
plan: 03
type: execute
wave: 3
depends_on: ["04-01", "04-02"]
files_modified:
  - src/components/memory/MemoryPanel.tsx
  - src/components/memory/MemoryCard.tsx
  - src/components/memory/MemoryEmptyState.tsx
  - src/components/memory/MemoryHeaderPill.tsx
  - src/hooks/useMemory.ts
  - src/store/memoryStore.ts
  - src/components/chat/ChatHeader.tsx
autonomous: false
requirements:
  - MEM-05
  - MEM-06
  - MEM-07
must_haves:
  truths:
    - "User can click header pill to open Memory Panel overlay"
    - "Memory Panel shows facts as cards grouped by category"
    - "User can edit facts inline (single-click) or full edit (double-click)"
    - "User can pin/unpin facts (max 10, pinned exempt from eviction)"
    - "User can delete facts with 4-second undo toast"
    - "User can clear all memory with 8-second deferred deletion and undo"
  artifacts:
    - path: "src/components/memory/MemoryPanel.tsx"
      provides: "Main memory panel sheet overlay"
      exports: ["MemoryPanel"]
    - path: "src/components/memory/MemoryCard.tsx"
      provides: "Individual memory fact card with edit/pin/delete"
      exports: ["MemoryCard"]
    - path: "src/components/memory/MemoryEmptyState.tsx"
      provides: "Empty state illustration and message"
      exports: ["MemoryEmptyState"]
    - path: "src/components/memory/MemoryHeaderPill.tsx"
      provides: "Header pill showing memory count"
      exports: ["MemoryHeaderPill"]
    - path: "src/hooks/useMemory.ts"
      provides: "Memory list and CRUD operations hook"
      exports: ["useMemory"]
    - path: "src/store/memoryStore.ts"
      provides: "Zustand store for UI state"
      exports: ["useMemoryStore"]
  key_links:
    - from: "src/components/memory/MemoryHeaderPill.tsx"
      to: "src/store/memoryStore.ts"
      via: "togglePanel action"
      pattern: "onClick opens panel"
    - from: "src/components/memory/MemoryCard.tsx"
      to: "src/hooks/useMemory.ts"
      via: "update/delete/pin actions"
      pattern: "mutation calls"
    - from: "src/hooks/useMemory.ts"
      to: "src/lib/storage/memory.ts"
      via: "CRUD operations"
      pattern: "saveMemoryFact|updateMemoryFact|deleteMemoryFact"
---

<objective>
Build the Memory Panel UI: a premium overlay for viewing, editing, pinning, and clearing memory facts. Users access it via a header pill, see facts as categorized cards, and have full control over their memory.

Purpose: The Memory Panel is the user's window into what the AI remembers about them. Without it, the memory system is opaque and untrustworthy. This plan delivers the transparency and control required for a privacy-first memory system.
Output: Complete Memory Panel UI with header pill, overlay sheet, cards, editing, pinning, and clear-all functionality.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-memory-system/04-CONTEXT.md
@.planning/phases/04-memory-system/04-RESEARCH.md

# Dependencies from previous plans
@src/lib/memory/types.ts
@src/lib/storage/memory.ts
@src/hooks/useConversations.ts

# UI patterns
@src/components/ui/sheet.tsx
@src/hooks/use-mobile.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Zustand Store and useMemory Hook</name>
  <files>
    src/store/memoryStore.ts
    src/hooks/useMemory.ts
  </files>
  <action>
    1. Create src/store/memoryStore.ts:

       ```typescript
       interface MemoryUIState {
         isPanelOpen: boolean;
         selectedCategory: MemoryCategory | "all";
         isManageMode: boolean;
         selectedFactIds: Set<string>;
         togglePanel: () => void;
         openPanel: () => void;
         closePanel: () => void;
         setSelectedCategory: (category: MemoryCategory | "all") => void;
         toggleManageMode: () => void;
         selectFact: (id: string) => void;
         deselectFact: (id: string) => void;
         clearSelection: () => void;
       }
       ```

       Implementation:
       - Use Zustand with persist middleware for selectedCategory only
       - Panel state is ephemeral (not persisted)
       - Manage mode enables bulk selection

    2. Create src/hooks/useMemory.ts:

       ```typescript
       interface UseMemoryReturn {
         // Data
         facts: MemoryFact[];
         isLoading: boolean;
         error: string | null;
         count: number;
         countByCategory: Record<MemoryCategory, number>;

         // CRUD
         addFact: (fact: Omit<MemoryFact, "id">) => Promise<void>;
         updateFact: (id: string, updates: Partial<MemoryFact>) => Promise<void>;
         deleteFact: (id: string) => Promise<void>;
         pinFact: (id: string) => Promise<void>;
         unpinFact: (id: string) => Promise<void>;
         clearAllFacts: () => Promise<void>;

         // Undo
         undoDelete: () => Promise<void>;
         undoClearAll: () => Promise<void>;

         // Refresh
         refresh: () => Promise<void>;
       }
       ```

       Implementation:
       - Use dexie-react-hooks useLiveQuery for reactive updates
       - Import CRUD functions from @/lib/storage/memory
       - Handle errors with user-friendly messages
       - Implement undo with 4-second window for deletes
       - Implement undo with 8-second window for clear all

       Undo pattern:
       ```typescript
       const deletedFactsRef = useRef<MemoryFact[]>([]);

       const deleteFact = async (id: string) => {
         const fact = facts.find(f => f.id === id);
         if (!fact) return;

         // Optimistic delete
         deletedFactsRef.current = [fact];
         await deleteMemoryFact(id);

         // Show toast with undo
         toast("Memory deleted", {
           action: {
             label: "Undo",
             onClick: () => undoDelete(),
           },
           duration: 4000,
         });
       };

       const undoDelete = async () => {
         const fact = deletedFactsRef.current.pop();
         if (fact) {
           await saveMemoryFact(fact);
         }
       };
       ```

       Clear all with deferred deletion:
       ```typescript
       const clearAllFacts = async () => {
         // Store backup
         const allFacts = await getMemoryFacts();
         if (allFacts.kind === "ok") {
           clearedFactsRef.current = allFacts.value;
         }

         // Visual clear immediately
         await clearAllMemory();

         // Show toast with progress bar
         toast("Memory cleared", {
           action: {
             label: "Undo",
             onClick: () => undoClearAll(),
           },
           duration: 8000,
         });
       };
       ```
  </action>
  <verify>
    - useMemory hook returns reactive facts list
    - CRUD operations work with proper error handling
    - Undo functionality stores facts for restoration
    - TypeScript compiles without errors
  </verify>
  <done>
    - memoryStore has panel state and category filter
    - useMemory provides reactive facts with live query
    - Delete has 4-second undo window
    - Clear all has 8-second undo window
  </done>
</task>

<task type="auto">
  <name>Task 2: Memory Card Component</name>
  <files>
    src/components/memory/MemoryCard.tsx
  </files>
  <action>
    Create src/components/memory/MemoryCard.tsx:

    1. Props interface:
       ```typescript
       interface MemoryCardProps {
         fact: MemoryFact;
         onUpdate: (id: string, updates: Partial<MemoryFact>) => void;
         onDelete: (id: string) => void;
         onPin: (id: string, pinned: boolean) => void;
         isManageMode?: boolean;
         isSelected?: boolean;
         onSelect?: (id: string) => void;
       }
       ```

    2. Category color accents (from CONTEXT.md):
       ```typescript
       const categoryColors: Record<MemoryCategory, string> = {
         project: "border-l-cyan-500 bg-cyan-50/50",
         preference: "border-l-purple-500 bg-purple-50/50",
         identity: "border-l-green-500 bg-green-50/50",
       };
       ```

    3. Component structure:
       - Card container with category left border
       - Pinned indicator (1px left border accent in brand orange when pinned)
       - Confidence bar (thin fill bar, not number)
       - Fact text (editable)
       - Category badge
       - Pin button (appears on hover)
       - Delete button (appears on hover or in manage mode)

    4. Edit modes:
       - Single-click: Inline edit (contenteditable or input)
         - Enter to save
         - Escape to cancel
         - Blur to save
       - Double-click: Full edit mode
         - Textarea for fact text
         - Category selector dropdown
         - Save/Cancel buttons

    5. Hover states:
       - Pin icon appears on hover (top-right)
       - Delete icon appears on hover (bottom-right)
       - Use framer-motion for smooth appearance

    6. Confidence bar:
       ```tsx
       <div className="h-1 w-full bg-gray-200 rounded-full overflow-hidden">
         <div
           className="h-full bg-orange-500 transition-all"
           style={{ width: `${fact.confidence * 100}%` }}
         />
       </div>
       ```

    7. Pinned state:
       - Show pin icon when pinned
       - Add orange left border when pinned (in addition to category color)
       - Pin button toggles pin state

    8. Manage mode:
       - Show checkbox when isManageMode is true
       - Checkbox state controlled by isSelected
       - Clicking card toggles selection
  </action>
  <verify>
    - Card renders with correct category colors
    - Single-click enters inline edit mode
    - Double-click enters full edit mode
    - Pin button toggles pin state
    - Delete button triggers onDelete
    - Confidence bar shows correct percentage
  </verify>
  <done>
    - MemoryCard has category color accents
    - Inline edit on single-click
    - Full edit on double-click
    - Pin/unpin functionality
    - Confidence indicator bar
    - Manage mode with checkboxes
  </done>
</task>

<task type="auto">
  <name>Task 3: Memory Panel and Header Pill</name>
  <files>
    src/components/memory/MemoryPanel.tsx
    src/components/memory/MemoryEmptyState.tsx
    src/components/memory/MemoryHeaderPill.tsx
  </files>
  <action>
    1. Create src/components/memory/MemoryEmptyState.tsx:

       Simple empty state with illustration:
       ```tsx
       export function MemoryEmptyState() {
         return (
           <div className="flex flex-col items-center justify-center py-12 text-center">
             <div className="text-4xl mb-4">ðŸ§ </div>
             <h3 className="text-lg font-medium text-gray-900">No memories yet</h3>
             <p className="text-sm text-gray-500 mt-1">
               I'll learn as we talk.
             </p>
           </div>
         );
       }
       ```

    2. Create src/components/memory/MemoryHeaderPill.tsx:

       ```typescript
       interface MemoryHeaderPillProps {
         count: number;
         onClick: () => void;
       }
       ```

       Design:
       - Pill shape (rounded-full)
       - Shows: "{count} memories â†—"
       - Hover: slight background change
       - Click: opens panel
       - Position: in chat header (passed to ChatHeader)

    3. Create src/components/memory/MemoryPanel.tsx:

       Uses shadcn/ui Sheet component for overlay:
       ```tsx
       import { Sheet, SheetContent, SheetHeader, SheetTitle } from "@/components/ui/sheet";
       ```

       Layout:
       - Right-side sheet (side="right")
       - Width: sm (default) or md for more space
       - Header: "Memory" with close button
       - Category filter tabs: All | Project | Preference | Identity
       - Scrollable fact list with grouped sections
       - "+ Remember something" composer at bottom
       - "Clear all memory" button at bottom (muted color)

       Category grouping:
       ```tsx
       const groupedFacts = useMemo(() => {
         const groups: Record<MemoryCategory, MemoryFact[]> = {
           project: [],
           preference: [],
           identity: [],
         };
         for (const fact of filteredFacts) {
           groups[fact.category].push(fact);
         }
         return groups;
       }, [filteredFacts]);
       ```

       Sections:
       - "Current work" (project facts)
       - "Preferences" (preference facts)
       - "About" (identity facts)

       Clear all flow:
       - Button at bottom: "Clear all memory" (muted gray)
       - Click shows inline confirmation:
         "This will remove all {count} facts. [Cancel] [Confirm]"
       - Confirm triggers clearAllFacts from useMemory

       Manage mode toggle:
       - "Manage" button in header
       - Toggles manage mode (shows checkboxes on cards)
       - In manage mode: bottom action bar with "Delete selected" button

    4. Create composer component (inline in MemoryPanel):
       ```tsx
       function MemoryComposer({ onAdd }: { onAdd: (fact: string) => void }) {
         const [value, setValue] = useState("");
         return (
           <div className="flex gap-2">
             <Input
               placeholder="+ Remember something..."
               value={value}
               onChange={(e) => setValue(e.target.value)}
               onKeyDown={(e) => {
                 if (e.key === "Enter" && value.trim()) {
                   onAdd(value.trim());
                   setValue("");
                 }
               }}
             />
           </div>
         );
       }
       ```
       - Auto-classify category via LLM (or default to preference)
       - Lower initial confidence (0.6) for manual facts
  </action>
  <verify>
    - Sheet opens/closes correctly
    - Category tabs filter facts
    - Facts grouped by category with headers
    - Clear all shows confirmation
    - Composer adds new facts
  </verify>
  <done>
    - MemoryPanel uses Sheet component
    - Category filter tabs work
    - Facts grouped by category
    - Clear all with confirmation
    - Composer for manual facts
  </done>
</task>

<task type="auto">
  <name>Task 4: Integration with Chat Interface</name>
  <files>
    src/components/chat/ChatHeader.tsx
  </files>
  <action>
    Integrate MemoryHeaderPill into the chat header:

    1. Locate ChatHeader component (or create if doesn't exist)

    2. Import components:
       ```typescript
       import { MemoryHeaderPill } from "@/components/memory/MemoryHeaderPill";
       import { MemoryPanel } from "@/components/memory/MemoryPanel";
       import { useMemory } from "@/hooks/useMemory";
       import { useMemoryStore } from "@/store/memoryStore";
       ```

    3. Add MemoryHeaderPill to header:
       ```tsx
       function ChatHeader() {
         const { count } = useMemory();
         const { openPanel } = useMemoryStore();

         return (
           <header className="flex items-center justify-between px-4 py-2 border-b">
             <div className="flex items-center gap-2">
               {/* Existing header content */}
             </div>
             <MemoryHeaderPill count={count} onClick={openPanel} />
           </header>
         );
       }
       ```

    4. Add MemoryPanel to chat layout:
       ```tsx
       function ChatLayout() {
         const { isPanelOpen, closePanel } = useMemoryStore();

         return (
           <>
             {/* Existing chat layout */}
             <MemoryPanel open={isPanelOpen} onClose={closePanel} />
           </>
         );
       }
       ```

    5. Add keyboard shortcut (Cmd/Ctrl+Shift+M):
       ```typescript
       useEffect(() => {
         const handleKeyDown = (e: KeyboardEvent) => {
           if ((e.metaKey || e.ctrlKey) && e.shiftKey && e.key === "m") {
             e.preventDefault();
             togglePanel();
           }
         };
         window.addEventListener("keydown", handleKeyDown);
         return () => window.removeEventListener("keydown", handleKeyDown);
       }, [togglePanel]);
       ```

    6. Ensure responsive behavior:
       - On mobile: Sheet takes full width or most of it
       - Header pill may need to show just icon on small screens
  </action>
  <verify>
    - MemoryHeaderPill appears in chat header
    - Clicking pill opens MemoryPanel
    - Keyboard shortcut works
    - Panel closes when clicking outside
  </verify>
  <done>
    - MemoryHeaderPill integrated into ChatHeader
    - MemoryPanel rendered in chat layout
    - Cmd/Ctrl+Shift+M keyboard shortcut works
    - Responsive on mobile
  </done>
</task>

<task type="checkpoint:human-verify">
  <name>Task 5: UI Verification</name>
  <files></files>
  <action>
    Human verification of complete Memory Panel UI:
    - Header pill showing memory count
    - Right-side sheet overlay with categorized cards
    - Inline and full edit modes
    - Pin/unpin functionality
    - Delete with 4-second undo
    - Clear all with 8-second undo
    - Keyboard shortcut (Cmd/Ctrl+Shift+M)
  </action>
  <verify>
    1. Open the app and navigate to a conversation
    2. Look for the memory pill in the header (should show "0 memories")
    3. Click the pill - Memory Panel should slide in from right
    4. Click "+ Remember something" and add a test fact
    5. Verify the card appears with correct category color
    6. Single-click the card - should enter inline edit
    7. Double-click the card - should enter full edit with category selector
    8. Hover over card - pin and delete buttons should appear
    9. Click pin - card should get orange left border
    10. Click delete - toast should appear with "Undo" button
    11. Click "Clear all memory" - confirmation should appear
    12. Press Cmd/Ctrl+Shift+M - panel should toggle
    13. Click outside panel - it should close
    Type "approved" or describe issues to continue.
  </verify>
  <done>
    All UI elements verified working:
    - Header pill opens panel
    - Cards display with correct category colors
    - Edit modes function correctly
    - Pin/unpin works
    - Undo toasts appear
    - Keyboard shortcut works
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Verify all components render without errors
2. Check that edit modes work correctly
3. Test undo functionality timing
4. Ensure keyboard shortcut works
</verification>

<success_criteria>
- Header pill shows memory count and opens panel on click
- Memory Panel displays facts as cards grouped by category
- Cards have category color accents (project=blue, preference=purple, identity=green)
- Single-click enters inline edit, double-click enters full edit
- Pin/unpin works with max 10 pinned limit
- Delete shows 4-second undo toast
- Clear all shows confirmation and 8-second undo
- Keyboard shortcut Cmd/Ctrl+Shift+M toggles panel
</success_criteria>

<output>
After completion, create `.planning/phases/04-memory-system/04-03-SUMMARY.md`
</output>
