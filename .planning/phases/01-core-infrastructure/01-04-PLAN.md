---
phase: 01-core-infrastructure
plan: 04
type: execute
wave: 2
depends_on:
  - 01-01
  - 01-02
files_modified:
  - vite.config.ts
  - public/manifest.json
  - src/components/performance/StatusIndicator.tsx
  - src/components/performance/PerformancePanel.tsx
  - src/lib/performance/metrics.ts
  - src/lib/performance/memory-monitor.ts
autonomous: false
requirements:
  - PERF-05
  - OFFL-01
  - OFFL-02
  - OFFL-03
  - OFFL-04
  - OFFL-05
must_haves:
  truths:
    - "Service Worker caches app assets for offline use"
    - "App shows 'Works Offline' indicator when SW is active"
    - "Performance panel displays GPU status and memory usage"
    - "Visual indicator shows system health (Green/Yellow/Red)"
    - "PWA manifest allows Add to Home Screen installation"
  artifacts:
    - path: "vite.config.ts"
      provides: "Vite PWA configuration with Service Worker"
    - path: "public/manifest.json"
      provides: "PWA manifest for installability"
    - path: "src/components/performance/StatusIndicator.tsx"
      provides: "Offline/online status badge"
    - path: "src/components/performance/PerformancePanel.tsx"
      provides: "GPU and memory stats display"
    - path: "src/lib/performance/metrics.ts"
      provides: "Performance tracking utilities"
    - path: "src/lib/performance/memory-monitor.ts"
      provides: "Memory usage monitoring"
  key_links:
    - from: "src/components/performance/StatusIndicator.tsx"
      to: "vite-plugin-pwa"
      via: "Service Worker registration status"
    - from: "src/components/performance/PerformancePanel.tsx"
      to: "src/lib/performance/gpu-detection.ts"
      via: "GPU info display"
    - from: "src/components/performance/PerformancePanel.tsx"
      to: "src/lib/performance/memory-monitor.ts"
      via: "Memory stats"
---

<objective>
Implement offline capability and performance monitoring: Service Worker for PWA functionality, "Works Offline" indicator, performance panel with GPU/memory stats, and system health indicator.

Purpose: Offline capability is a core value proposition (privacy-first, works without internet). Performance monitoring helps users understand their system capabilities and troubleshoot issues.
Output: PWA configuration, Service Worker integration, StatusIndicator component, PerformancePanel component, and monitoring utilities.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/STACK.md
@.planning/research/ARCHITECTURE.md
@.planning/1-CONTEXT.md

Phase 1 Context (locked decisions):
- Service Worker caches application assets for offline use
- Downloaded models remain available offline (WebLLM handles this)
- Clear indicator shows "Works Offline" or "Online Required"
- Badge position: Bottom-left corner or status bar area
- States: Loading (hidden/gray), Ready (green "Works Offline"), Error (warning)
- Tooltip: "App cached for offline use"
- Performance panel shows GPU status (Active/Inactive/Not Supported)
- Performance panel shows memory usage (MB / total available)
- Visual indicator shows system health (Green/Yellow/Red)
- PWA manifest allows "Add to Home Screen" installation
</context>

<tasks>

<task type="auto">
<name>Task 1: Configure Vite PWA plugin and Service Worker</name>
<files>vite.config.ts, public/manifest.json</files>
<action>
Set up PWA configuration for offline capability:

1. Update vite.config.ts:
   - Import { VitePWA } from "vite-plugin-pwa"
   - Add VitePWA() to plugins array
   - Configure PWA options:
     * registerType: "autoUpdate" (auto-update service worker)
     * manifest: false (we'll use separate manifest.json)
     * workbox: {
         globPatterns: ["**/*.{js,css,html,ico,png,svg,woff,woff2}"]
       }
     * devOptions: { enabled: true } (for development testing)

2. Create/update public/manifest.json:
   - name: "Lokul"
   - short_name: "Lokul"
   - description: "Privacy-first AI chat that runs 100% in your browser"
   - start_url: "/"
   - display: "standalone"
   - background_color: "#FF6B35" (primary brand color)
   - theme_color: "#FF6B35"
   - icons: [
       { src: "/lokul-logo.png", sizes: "any", type: "image/svg+xml" }
     ]

3. Add to index.html head:
   - <link rel="manifest" href="/manifest.json" />
   - <meta name="theme-color" content="#FF6B35" />

Follow vite-plugin-pwa documentation for proper configuration.
</action>
<verify>
grep -q "vite-plugin-pwa" vite.config.ts && \
grep -q "VitePWA" vite.config.ts && \
grep -q "registerType.*autoUpdate" vite.config.ts && \
grep -q '"name": "Lokul"' public/manifest.json && \
grep -q '"display": "standalone"' public/manifest.json
</verify>
<done>Vite PWA plugin configured with auto-update Service Worker and manifest.json for installability</done>
</task>

<task type="auto">
<name>Task 2: Create performance monitoring utilities</name>
<files>src/lib/performance/metrics.ts, src/lib/performance/memory-monitor.ts</files>
<action>
Create performance monitoring utilities:

1. src/lib/performance/metrics.ts:
   - Define SystemHealth type: "healthy" | "warning" | "critical"
   - Define PerformanceMetrics interface with:
     * gpuStatus: "active" | "inactive" | "unsupported"
     * gpuName: string | null
     * memoryUsedMB: number
     * memoryTotalMB: number | null
     * health: SystemHealth
   - Export getSystemHealth(): SystemHealth function:
     * Check GPU support
     * Check memory usage (if available)
     * Return "healthy" if GPU active + memory OK
     * Return "warning" if GPU active but memory high
     * Return "critical" if no GPU or memory critical

2. src/lib/performance/memory-monitor.ts:
   - Export getMemoryInfo(): { used: number; total: number | null }:
     * Use performance.memory if available (Chrome)
     * used = usedJSHeapSize / 1048576 (convert to MB)
     * total = totalJSHeapSize / 1048576
     * Return null for total if not available
   - Export formatMemory(mb: number): string:
     * Return "X MB" if < 1024
     * Return "X GB" if >= 1024 (with 1 decimal)

Follow patterns from ARCHITECTURE.md. Keep utilities pure and testable.
</action>
<verify>
grep -q "export type SystemHealth" src/lib/performance/metrics.ts && \
grep -q "export function getSystemHealth" src/lib/performance/metrics.ts && \
grep -q "export function getMemoryInfo" src/lib/performance/memory-monitor.ts && \
grep -q "export function formatMemory" src/lib/performance/memory-monitor.ts
</verify>
<done>Performance utilities created for health calculation and memory monitoring</done>
</task>

<task type="auto">
<name>Task 3: Create StatusIndicator component</name>
<files>src/components/performance/StatusIndicator.tsx</files>
<action>
Create the offline/online status indicator component:

1. Component structure:
   - Position: Fixed bottom-left (left-4 bottom-4)
   - Badge style with icon + text
   - Three states with distinct colors:

2. State: "checking"
   - Icon: Loader2 (spinning)
   - Text: "Checking..."
   - Color: Gray/secondary
   - Tooltip: "Verifying offline capability"

3. State: "offline-ready"
   - Icon: CloudCheck
   - Text: "Works Offline"
   - Color: Green (text-green-600 bg-green-50)
   - Tooltip: "App cached for offline use"

4. State: "online-required"
   - Icon: CloudX or WifiOff
   - Text: "Online Required"
   - Color: Yellow/amber (text-amber-600 bg-amber-50)
   - Tooltip: "First-time setup needs internet"

5. Implementation:
   - Use useRegisterSW from "virtual:pwa-register/react"
   - Track online/offline status with window "online"/"offline" events
   - Show "offline-ready" when SW is registered AND (online OR cached)
   - Show "online-required" when no SW or no cache
   - Tooltip on hover using title attribute or custom tooltip

Props: None (self-contained)

Follow locked decisions for positioning and states.
</action>
<verify>
grep -q "export function StatusIndicator" src/components/performance/StatusIndicator.tsx && \
grep -q "useRegisterSW" src/components/performance/StatusIndicator.tsx && \
grep -q "Works Offline" src/components/performance/StatusIndicator.tsx && \
grep -q "Online Required" src/components/performance/StatusIndicator.tsx
</verify>
<done>StatusIndicator component created with three states (checking, offline-ready, online-required) and tooltips</done>
</task>

<task type="auto">
<name>Task 4: Create PerformancePanel component</name>
<files>src/components/performance/PerformancePanel.tsx</files>
<action>
Create the performance stats panel:

1. Component structure:
   - Card-style panel with header "Performance"
   - Grid layout for stats (2 columns)
   - Health indicator at top

2. Stats to display:
   - GPU Status: Icon + text ("Active", "Inactive", "Not Supported")
     * Green checkmark for Active
     * Gray X for Not Supported
   - GPU Name: Show device name if available
   - Memory: "X MB / Y MB" or "X MB used"
   - Health: Color-coded badge (Green/Yellow/Red)

3. Data sources:
   - Use checkWebGPUSupport() for GPU info
   - Use getMemoryInfo() for memory stats
   - Use getSystemHealth() for health status

4. Real-time updates:
   - useEffect with interval (5 seconds) to refresh memory
   - Cleanup interval on unmount

5. Styling:
   - Compact design (fits in sidebar or overlay)
   - Monospace font for numbers
   - Color coding: Green (healthy), Yellow (warning), Red (critical)

Props interface: { className?: string }

Health colors:
- healthy: bg-green-100 text-green-800
- warning: bg-yellow-100 text-yellow-800
- critical: bg-red-100 text-red-800
</action>
<verify>
grep -q "export function PerformancePanel" src/components/performance/PerformancePanel.tsx && \
grep -q "checkWebGPUSupport" src/components/performance/PerformancePanel.tsx && \
grep -q "getMemoryInfo" src/components/performance/PerformancePanel.tsx && \
grep -q "getSystemHealth" src/components/performance/PerformancePanel.tsx && \
grep -q "GPU Status" src/components/performance/PerformancePanel.tsx
</verify>
<done>PerformancePanel component created with GPU status, memory usage, and health indicator</done>
</task>

<task type="auto">
<name>Task 5: Integrate indicators into App.tsx</name>
<files>src/App.tsx</files>
<action>
Update App.tsx to include status and performance indicators:

1. Import components:
   - StatusIndicator from "./components/performance/StatusIndicator"
   - PerformancePanel from "./components/performance/PerformancePanel"

2. Layout updates:
   - StatusIndicator: Fixed position bottom-left (always visible)
   - PerformancePanel: Show in "chat" state (sidebar or corner)

3. For chat state layout:
   - Main area: "Chat Interface" placeholder
   - Sidebar or corner: PerformancePanel
   - Bottom-left: StatusIndicator (already positioned)

4. Conditional rendering:
   - Only show PerformancePanel when appState === "chat"
   - StatusIndicator always visible (shows loading state during setup)

5. Add PerformancePanel toggle:
   - Small button to show/hide performance panel
   - Icon: Activity or Gauge
   - Position: Top-right or in header area

Update imports and ensure all components are properly integrated.
</action>
<verify>
grep -q "StatusIndicator" src/App.tsx && \
grep -q "PerformancePanel" src/App.tsx && \
grep -q "performance" src/App.tsx
</verify>
<done>StatusIndicator and PerformancePanel integrated into App.tsx layout</done>
</task>

<task type="checkpoint:human-verify">
<what-built>
Offline capability and performance monitoring:
- Vite PWA plugin with Service Worker
- PWA manifest for installability
- StatusIndicator with Works Offline badge
- PerformancePanel with GPU/memory stats
- System health indicator (Green/Yellow/Red)
</what-built>
<how-to-verify>
1. Build for production: npm run build
2. Serve build locally: npx serve dist
3. Test PWA installability:
   - Open Chrome DevTools → Application → Manifest
   - Verify manifest is valid
   - Check "Add to Home Screen" prompt appears
4. Test Service Worker:
   - DevTools → Application → Service Workers
   - Verify SW is registered and activated
   - Check "Offline" checkbox
   - Refresh page - app should still load
5. Test StatusIndicator:
   - Verify "Works Offline" badge appears (green)
   - Hover shows tooltip "App cached for offline use"
6. Test PerformancePanel:
   - Toggle performance panel visible
   - Verify GPU status shows (Active/Inactive/Not Supported)
   - Verify memory usage displays in MB
   - Verify health indicator color (Green/Yellow/Red)
</how-to-verify>
<resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:
1. Service Worker caches assets for offline use
2. "Works Offline" indicator shows when SW is active
3. Performance panel displays GPU status and memory usage
4. System health indicator shows Green/Yellow/Red
5. PWA manifest allows Add to Home Screen
6. App functions without internet after first load (with cached model)
</verification>

<success_criteria>
- Vite PWA plugin configured with auto-update Service Worker
- PWA manifest valid for installation
- StatusIndicator shows Works Offline when cached
- PerformancePanel displays GPU status (Active/Inactive/Not Supported)
- PerformancePanel shows memory usage (MB)
- Visual health indicator shows Green/Yellow/Red
- App works offline after first load
- TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-infrastructure/01-04-SUMMARY.md` documenting:
- PWA configuration
- Service Worker behavior
- Status indicator states
- Performance panel features
</output>
