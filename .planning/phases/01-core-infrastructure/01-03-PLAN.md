---
phase: 01-core-infrastructure
plan: 03
type: execute
wave: 2
depends_on:
  - 01-01
  - 01-02
files_modified:
  - src/components/onboarding/FirstRunSetup.tsx
  - src/components/onboarding/LoadingScreen.tsx
  - src/components/ui/Button.tsx
  - src/components/ui/Progress.tsx
  - src/App.tsx
autonomous: false
requirements:
  - FIRST-01
  - FIRST-02
  - FIRST-03
  - FIRST-04
  - FIRST-05
must_haves:
  truths:
    - "User sees 'Start Chatting' button within 2 seconds of landing"
    - "User receives clear error if WebGPU is not supported"
    - "User sees honest progress during Quick Mode download (percentage + estimated time)"
    - "User can send first message within 60 seconds of landing page load"
    - "Progress is cancelable"
  artifacts:
    - path: "src/components/onboarding/FirstRunSetup.tsx"
      provides: "Landing page with WebGPU check and Start Chatting CTA"
      min_lines: 80
    - path: "src/components/onboarding/LoadingScreen.tsx"
      provides: "Model download progress UI with percentage and time estimate"
      min_lines: 60
    - path: "src/components/ui/Button.tsx"
      provides: "Reusable button component with variants"
    - path: "src/components/ui/Progress.tsx"
      provides: "Progress bar component"
    - path: "src/App.tsx"
      provides: "Main app with onboarding flow integration"
  key_links:
    - from: "src/components/onboarding/FirstRunSetup.tsx"
      to: "src/lib/performance/gpu-detection.ts"
      via: "WebGPU check on mount"
      pattern: "checkWebGPUSupport"
    - from: "src/components/onboarding/FirstRunSetup.tsx"
      to: "src/components/onboarding/LoadingScreen.tsx"
      via: "Conditional rendering after CTA click"
    - from: "src/components/onboarding/LoadingScreen.tsx"
      to: "src/store/modelStore.ts"
      via: "Model loading state and progress"
      pattern: "useModelStore"
---

<objective>
Build the first-run experience: landing page with "Start Chatting" CTA, WebGPU capability detection with clear error messages, and loading screen with honest progress indicators for Quick Mode download.

Purpose: This is the user's first impression. The 2-second CTA visibility and 60-second first-message targets are critical for user retention. Clear error messaging for unsupported browsers prevents frustration.
Output: FirstRunSetup component, LoadingScreen component, reusable UI primitives (Button, Progress), and App.tsx integration.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/1-CONTEXT.md

Phase 1 Context (locked decisions):
- Landing: Simple hero page with app name (Lokul), tagline ("Privacy-first AI chat"), prominent "Start Chatting" CTA
- Layout: Centered card design with logo above, single CTA below
- Quick Mode auto-loads on first visit (no user choice needed for initial load)
- Progress shown: Percentage (0-100%), loading step label, time estimate
- Cancelable: Yes
- Logo: Spark/flame icon (public/spark-logo.svg)
- Animation: Subtle pulsing loader
- WebGPU detection: Check `navigator.gpu` availability
- Error message: "Your browser doesn't support WebGPU", "Lokul requires Chrome 120+ or Edge 120+"
- Actionable: Direct links to download Chrome/Edge
- No fallback: No polyfill or degraded mode
- Progress bar: Horizontal with percentage text
- Time estimates: "About X seconds/minutes remaining" based on rolling average
- Steps: "Downloading Phi-2 model...", "Compiling shaders...", "Ready!"
</context>

<tasks>

<task type="auto">
<name>Task 1: Create reusable UI primitives (Button, Progress)</name>
<files>src/components/ui/Button.tsx, src/components/ui/Progress.tsx</files>
<action>
Create reusable UI components following shadcn/ui patterns:

1. src/components/ui/Button.tsx:
   - Use class-variance-authority (CVA) for variants
   - Variants: primary (bg-primary text-white), secondary, ghost, destructive
   - Sizes: sm, md, lg
   - Props: variant, size, disabled, loading, onClick, children
   - Use Tailwind for styling with focus states and transitions
   - Support disabled and loading states (show spinner when loading)

2. src/components/ui/Progress.tsx:
   - Props: value (0-100), max (default 100), showLabel (boolean)
   - Horizontal progress bar with fill animation
   - Label showing "X%" when showLabel is true
   - Use primary color for fill, gray for track
   - Smooth transition on value changes

Follow CLAUDE.md component guidelines (max 200 lines, single responsibility).
</action>
<verify>
grep -q "export function Button" src/components/ui/Button.tsx && \
grep -q "cva" src/components/ui/Button.tsx && \
grep -q "export function Progress" src/components/ui/Progress.tsx && \
grep -q "value.*number" src/components/ui/Progress.tsx
</verify>
<done>Button and Progress components created with variants, loading states, and proper TypeScript props</done>
</task>

<task type="auto">
<name>Task 2: Create FirstRunSetup landing component</name>
<files>src/components/onboarding/FirstRunSetup.tsx</files>
<action>
Create the landing page component:

1. Component structure:
   - Centered card layout with max-width-md
   - Logo: spark-logo.svg at top (w-16 h-16)
   - Heading: "Lokul" (text-3xl font-bold)
   - Tagline: "Privacy-first AI chat" (text-muted-foreground)
   - Single CTA: "Start Chatting" Button (primary, lg size)

2. WebGPU detection on mount:
   - useEffect to check WebGPU immediately on component mount
   - Use checkWebGPUSupport() from lib/performance/gpu-detection
   - Store result in state: gpuStatus: "checking" | "supported" | "unsupported"

3. Error state for unsupported WebGPU:
   - Hide "Start Chatting" button
   - Show error icon (alert triangle)
   - Heading: "Your browser doesn't support WebGPU"
   - Subtext: "Lokul requires Chrome 120+ or Edge 120+"
   - Action buttons: "Download Chrome" and "Download Edge" links
   - Use getRecommendedBrowsers() for URLs

4. Success state:
   - Show "Start Chatting" button
   - On click: call onStart callback prop

5. Loading state:
   - Brief "checking" state while detecting GPU (should be < 500ms)

Props interface: { onStart: () => void }

Follow locked decisions exactly for error messages and layout.
</action>
<verify>
grep -q "export function FirstRunSetup" src/components/onboarding/FirstRunSetup.tsx && \
grep -q "checkWebGPUSupport" src/components/onboarding/FirstRunSetup.tsx && \
grep -q "Start Chatting" src/components/onboarding/FirstRunSetup.tsx && \
grep -q "Your browser doesn't support WebGPU" src/components/onboarding/FirstRunSetup.tsx && \
grep -q "onStart" src/components/onboarding/FirstRunSetup.tsx
</verify>
<done>FirstRunSetup component created with WebGPU detection, error state with browser links, and Start Chatting CTA</done>
</task>

<task type="auto">
<name>Task 3: Create LoadingScreen component</name>
<files>src/components/onboarding/LoadingScreen.tsx</files>
<action>
Create the model loading progress component:

1. Component structure:
   - Centered layout with max-width-sm
   - Loading animation: Subtle pulsing spinner or logo pulse
   - Step label: Dynamic based on loadingStep
   - Progress bar: Shows download percentage
   - Time estimate: "About X seconds remaining"
   - Cancel button: Secondary button to abort download

2. State integration:
   - Use useModelStore to get:
     * isLoading
     * downloadProgress (loaded, total, percentage, estimatedTimeSeconds)
     * loadingStep ("downloading" | "compiling" | "ready")
     * error
   - Subscribe to progress updates automatically

3. Step labels (per locked decisions):
   - downloading: "Downloading Phi-2 model..."
   - compiling: "Compiling shaders..."
   - ready: "Ready!"
   - error: "Failed to load model"

4. Time estimate formatting:
   - If estimatedTimeSeconds < 60: "About X seconds remaining"
   - If 60 <= estimatedTimeSeconds < 300: "About X minutes remaining"
   - If >= 300: "Several minutes remaining"
   - Show range for uncertainty: "30-45 seconds"

5. Cancel functionality:
   - Call cancelDownload() from model store
   - Show confirmation: "Are you sure? Download will be lost."
   - On confirm, reset and return to landing

6. Progress bar:
   - Use Progress component with showLabel
   - Throttle updates to prevent jitter (100ms)

Props interface: { onCancel: () => void, onReady: () => void }

Call onReady when loadingStep === "ready".
</action>
<verify>
grep -q "export function LoadingScreen" src/components/onboarding/LoadingScreen.tsx && \
grep -q "useModelStore" src/components/onboarding/LoadingScreen.tsx && \
grep -q "Downloading Phi-2 model" src/components/onboarding/LoadingScreen.tsx && \
grep -q "Cancel" src/components/onboarding/LoadingScreen.tsx && \
grep -q "seconds remaining" src/components/onboarding/LoadingScreen.tsx
</verify>
<done>LoadingScreen component created with progress bar, step labels, time estimates, and cancel functionality</done>
</task>

<task type="auto">
<name>Task 4: Integrate onboarding flow in App.tsx</name>
<files>src/App.tsx</files>
<action>
Update App.tsx to orchestrate the first-run experience:

1. State management:
   - useState for appState: "landing" | "loading" | "chat" | "error"
   - useEffect to check if user has completed setup (from settings store)

2. Flow logic:
   - On mount: Check settings.hasCompletedSetup
     * If true: Skip to "chat" state
     * If false: Show "landing" state

   - landing state:
     * Render FirstRunSetup
     * onStart callback: set appState to "loading", trigger model load

   - loading state:
     * Render LoadingScreen
     * Trigger useModelStore.getState().loadModel(QUICK_MODEL.id) on enter
     * onCancel callback: set appState back to "landing"
     * onReady callback: set appState to "chat", save hasCompletedSetup: true

   - chat state:
     * Render placeholder "Chat Interface" (Phase 2 will implement)
     * Show "Ready to chat!" message for now

3. Settings persistence:
   - When model is ready, call updateSettings({ hasCompletedSetup: true })
   - This ensures returning users skip onboarding

4. Error handling:
   - If model loading fails, show error state with retry button

5. Layout:
   - Full-screen centered layout
   - Warm gradient background (per CLAUDE.md branding)
   - Smooth transitions between states

Import paths:
- FirstRunSetup from "./components/onboarding/FirstRunSetup"
- LoadingScreen from "./components/onboarding/LoadingScreen"
- useSettingsStore from "./store/settingsStore"
- useModelStore from "./store/modelStore"
- QUICK_MODEL from "./lib/ai/models"
</action>
<verify>
grep -q "FirstRunSetup" src/App.tsx && \
grep -q "LoadingScreen" src/App.tsx && \
grep -q "useSettingsStore" src/App.tsx && \
grep -q "useModelStore" src/App.tsx && \
grep -q "QUICK_MODEL" src/App.tsx && \
grep -q "landing" src/App.tsx && \
grep -q "loading" src/App.tsx
</verify>
<done>App.tsx integrated with onboarding flow: landing → loading → chat states with proper transitions</done>
</task>

<task type="checkpoint:human-verify">
<what-built>
Complete first-run experience:
- FirstRunSetup landing page with WebGPU detection
- LoadingScreen with progress bar and time estimates
- UI primitives (Button, Progress)
- App.tsx flow integration
</what-built>
<how-to-verify>
1. Start development server: npm run dev
2. Open http://localhost:5173 in Chrome/Edge 120+
3. Verify:
   - "Start Chatting" button visible within 2 seconds
   - Clicking button shows loading screen
   - Progress bar shows 0-100% with "Downloading Phi-2 model..."
   - Time estimate shown (e.g., "About 30 seconds remaining")
   - Cancel button works (returns to landing)
4. Test WebGPU error:
   - Open in Safari or older browser
   - Verify error message: "Your browser doesn't support WebGPU"
   - Verify Chrome/Edge download links shown
5. Verify persistence:
   - Complete setup (let model load)
   - Refresh page
   - Should skip to chat state (not show landing again)
</how-to-verify>
<resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:
1. FirstRunSetup renders within 2 seconds
2. WebGPU detection works (shows error in unsupported browsers)
3. LoadingScreen shows progress (0-100%) and time estimates
4. Cancel button returns to landing
5. Settings persist (returning users skip onboarding)
6. Visual design matches locked decisions (centered card, spark logo)
</verification>

<success_criteria>
- Landing page shows within 2 seconds with "Start Chatting" CTA
- WebGPU error shows clear message with browser download links
- Loading screen displays honest progress with percentage and time estimate
- Download is cancelable
- Onboarding completion persists across sessions
- TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-infrastructure/01-03-SUMMARY.md` documenting:
- First-run flow states
- WebGPU detection UX
- Progress indicator design
- Component structure
</output>
