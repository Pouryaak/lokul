---
phase: 05-polish-and-pwa
plan: 04
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/components/performance/StatusIndicator.tsx
  - src/hooks/useInstallEligibility.ts
  - src/hooks/use-ai-chat-persistence.ts
  - src/types/pwa.ts
  - src/types/vite-env.d.ts
  - public/manifest.json
autonomous: true
requirements:
  - CHAT-09
must_haves:
  truths:
    - "Install affordance appears in the header only when eligible and after first successful chat"
    - "Install affordance is hidden silently when unavailable, unsupported, private context, or dismissed in the current session"
    - "Offline transitions update compact status text/icon without toast or inline interruption"
    - "Successful install hides install action permanently for installed session"
    - "After dismissing install, affordance is suppressed for the current session but can reappear in the next session if still eligible"
  artifacts:
    - path: "src/components/performance/StatusIndicator.tsx"
      provides: "Compact header status indicator with install action and offline state"
      exports: ["StatusIndicator"]
    - path: "src/hooks/useInstallEligibility.ts"
      provides: "Eligibility state machine combining prompt availability, install status, and first-chat gate"
      exports: ["useInstallEligibility"]
    - path: "src/hooks/use-ai-chat-persistence.ts"
      provides: "First-successful-chat milestone signal for install gating"
      exports: ["useChatPersistence"]
    - path: "public/manifest.json"
      provides: "Install-quality manifest icon metadata"
      contains: "192x192 and 512x512 PNG icon entries"
  key_links:
    - from: "src/components/performance/StatusIndicator.tsx"
      to: "src/hooks/useInstallEligibility.ts"
      via: "header install action + compact status rendering"
      pattern: "useInstallEligibility"
    - from: "src/hooks/useInstallEligibility.ts"
      to: "src/hooks/use-ai-chat-persistence.ts"
      via: "first-successful-chat eligibility gate"
      pattern: "firstSuccessfulChat|installEligible"
---

<objective>
Deliver the Phase 5 install/offline UX model: compact top-right status indicator, subtle install action only when eligible, and silent hide behavior in unsupported contexts.

Purpose: The app should feel installable and native-like without noisy prompts or dead-end install buttons, while preserving mobile and desktop parity.
Output: Install eligibility hook/state machine, corrected status indicator behavior, first-chat gate signal, and hardened manifest metadata.
</objective>

<execution_context>
@/Users/poak/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/poak/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-polish-and-pwa/05-CONTEXT.md
@.planning/phases/05-polish-and-pwa/05-RESEARCH.md
@src/components/performance/StatusIndicator.tsx
@src/hooks/use-ai-chat-persistence.ts
@public/manifest.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build install eligibility state machine and type safety</name>
  <files>
    src/hooks/useInstallEligibility.ts
    src/types/pwa.ts
    src/types/vite-env.d.ts
  </files>
  <action>
    Implement `useInstallEligibility` to encapsulate install state: hidden/eligible/prompted/installed with gates for deferred prompt availability, display-mode installed checks, first-successful-chat completion, and unsupported/private-context fallback. Add explicit dismissal lifecycle handling: when the user dismisses the install prompt, record a session-scoped suppression flag so install affordance stays hidden for the rest of that browser session, then re-evaluate from a clean state in the next session so the affordance can reappear if still eligible. Add strict TypeScript support for `beforeinstallprompt` and `appinstalled` events and remove reliance on broad `ts-expect-error` usage around PWA hooks where feasible.
  </action>
  <verify>
    - npm run type-check
    - Eligibility stays hidden when prompt event is absent
    - Dismissing install suppresses affordance for the remainder of the current browser session (including refresh)
    - Starting a new browser session with the same eligible context allows install affordance to reappear
    - Installed display mode transitions state to installed and suppresses prompt action
  </verify>
  <done>
    - Install eligibility logic exists in one reusable hook
    - Dismissal suppression is session-scoped and does not permanently block future install eligibility
    - Install-related browser events are typed cleanly
    - Unsupported/private contexts produce silent hidden state
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor status indicator to compact top-right install/offline UX</name>
  <files>
    src/components/performance/StatusIndicator.tsx
    src/hooks/useInstallEligibility.ts
  </files>
  <action>
    Update StatusIndicator to a compact icon+label style suitable for top-right header placement and integrate install action behavior from `useInstallEligibility`. Correct `useRegisterSW` tuple handling (`offlineReady: [offlineReady]`) and ensure offline changes are represented through status changes only (no toasts/inline interruption). Hide install affordance after install success and when ineligible.
  </action>
  <verify>
    - npm run type-check
    - Header status updates when toggling browser offline/online mode without toast spam
    - Install action appears only when eligible and disappears after appinstalled event
  </verify>
  <done>
    - Status indicator is compact and header-ready
    - Install action behavior matches locked Phase 5 decisions
    - Offline UX is status-only with no disruptive notifications
  </done>
</task>

<task type="auto">
  <name>Task 3: Gate install by first successful chat and harden manifest install metadata</name>
  <files>
    src/hooks/use-ai-chat-persistence.ts
    public/manifest.json
  </files>
  <action>
    Add a deterministic "first successful chat" milestone signal from chat persistence success path, then consume it in install eligibility gating so install UI appears only after a successful chat has been completed. Update manifest icon metadata to valid install-quality entries (correct MIME types and explicit 192/512 PNG entries) without altering brand assets.
  </action>
  <verify>
    - npm run type-check
    - Fresh session before first successful chat shows no install action
    - After successful chat persistence, eligible sessions surface install action in header
    - Lighthouse/PWA install checks report valid manifest icon entries
  </verify>
  <done>
    - Install action is gated by first successful chat completion
    - Manifest icon entries are valid and explicit for install flows
    - Existing chat persistence reliability semantics remain intact
  </done>
</task>

</tasks>

<verification>
1. Verify install affordance behavior across eligible, ineligible, dismissed (session-scoped), next-session re-eligible, and installed states.
2. Verify offline/online toggles only update status indicator text/icon.
3. Verify first-chat gate works from clean profile through first successful message flow.
</verification>

<success_criteria>
- Compact install/offline indicator behavior is consistent with locked Phase 5 decisions.
- Install prompt appears only in eligible contexts after first successful chat.
- Manifest metadata supports high-quality installability on supported browsers.
</success_criteria>

<output>
After completion, create `.planning/phases/05-polish-and-pwa/05-04-SUMMARY.md`
</output>
