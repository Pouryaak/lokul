---
phase: 05-polish-and-pwa
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/components/chat-layout/chat-topbar-menu.tsx
  - src/components/chat-layout/ChatLayout.tsx
  - src/lib/storage/conversation-transfer.ts
  - src/lib/storage/conversation-transfer.test.ts
  - src/types/index.ts
autonomous: true
requirements:
  - STOR-05
  - STOR-06
  - STOR-07
  - STOR-08
must_haves:
  truths:
    - "User can export the current conversation as Markdown, JSON, or Text from the per-chat 3-dot menu"
    - "JSON import runs guided validation checks before allowing import"
    - "If imported conversation ID conflicts with existing data, user is prompted per conflict to replace or duplicate"
  artifacts:
    - path: "src/components/chat-layout/chat-topbar-menu.tsx"
      provides: "Per-chat 3-dot menu with import/export actions"
      exports: ["ChatTopbarMenu"]
    - path: "src/lib/storage/conversation-transfer.ts"
      provides: "Conversation serializers, parser/validator, and conflict-aware import flow"
      exports: ["exportConversationMarkdown", "exportConversationJson", "exportConversationText", "importConversationJson"]
    - path: "src/lib/storage/conversation-transfer.test.ts"
      provides: "Regression coverage for serializers, schema validation, and conflict branches"
    - path: "src/components/chat-layout/ChatLayout.tsx"
      provides: "Top bar menu wiring for active chat context"
      exports: ["ChatLayout"]
  key_links:
    - from: "src/components/chat-layout/chat-topbar-menu.tsx"
      to: "src/lib/storage/conversation-transfer.ts"
      via: "menu action handlers for each format/import step"
      pattern: "exportConversation|importConversation"
    - from: "src/lib/storage/conversation-transfer.ts"
      to: "src/lib/storage/conversations.ts"
      via: "getConversation/saveConversation for conflict resolution"
      pattern: "getConversation|saveConversation"
---

<objective>
Implement per-chat import/export capabilities through a top-bar 3-dot menu with equal Markdown/JSON/Text export options and guided JSON import checks.

Purpose: STOR-05 through STOR-08 require reliable local backup/restore flows with explicit conflict handling, while honoring the locked UX location and parity decisions.
Output: Transfer service module, menu UI, import guidance flow, and tests.
</objective>

<execution_context>
@/Users/poak/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/poak/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-polish-and-pwa/05-CONTEXT.md
@.planning/phases/05-polish-and-pwa/05-RESEARCH.md
@src/components/chat-layout/ChatLayout.tsx
@src/lib/storage/conversations.ts
@src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build conversation transfer module with format serializers</name>
  <files>
    src/lib/storage/conversation-transfer.ts
    src/types/index.ts
  </files>
  <action>
    Create a transfer module that serializes a `Conversation` into Markdown, JSON, and Text outputs with deterministic ordering and metadata. Define a versioned JSON backup envelope in `src/types/index.ts` (or closely related types) so export/import logic shares one canonical schema. Keep Blob/download trigger logic separate from serialization logic to maintain testability.
  </action>
  <verify>
    - npm run type-check
    - Unit-level checks confirm serializers produce non-empty output for representative conversation data
    - JSON export includes explicit schema version marker
  </verify>
  <done>
    - Markdown, JSON, and Text serializers exist and are callable independently
    - JSON schema is versioned and typed
    - Serialization logic is decoupled from UI/menu concerns
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement guided JSON import with conflict prompts</name>
  <files>
    src/lib/storage/conversation-transfer.ts
    src/lib/storage/conversation-transfer.test.ts
  </files>
  <action>
    Implement guided import steps: parse file text, validate schema, validate message integrity, check existing conversation ID, then resolve each conflict via explicit replace-or-duplicate choice before writing. Keep import completion blocked until all checks pass. Add tests for valid payload, malformed payload, missing required fields, and conflict resolution branches.
  </action>
  <verify>
    - npm run type-check
    - npm run test -- conversation-transfer
    - Invalid JSON and invalid schema paths return safe, actionable errors without writes
  </verify>
  <done>
    - Import pipeline has ordered validation gates before persistence writes
    - Per-conflict decision hook/path exists for replace vs duplicate
    - Tests cover success and failure paths
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire top-bar 3-dot menu for import/export actions</name>
  <files>
    src/components/chat-layout/chat-topbar-menu.tsx
    src/components/chat-layout/ChatLayout.tsx
  </files>
  <action>
    Add a per-chat top-bar 3-dot menu component and mount it in ChatLayout header actions. Present Markdown, JSON, and Text export entries with equal visual priority and include JSON import flow entry. Connect actions to transfer module and provide minimal user feedback for completion/failure while keeping copy concise. Menu should only operate when a concrete chat context is active.
  </action>
  <verify>
    - npm run type-check
    - In active chat, 3-dot menu shows export/import actions
    - Export downloads produce .md, .json, and .txt files; import validates before write
  </verify>
  <done>
    - 3-dot menu exists in per-chat top bar and is usable
    - Export options are parity-level choices (no hidden secondary format)
    - Import flow enforces guided checks and conflict decisions
  </done>
</task>

</tasks>

<verification>
1. Verify export of same conversation in all three formats from the top-bar menu.
2. Verify JSON import happy-path creates/restores conversation data.
3. Verify conflict flow prompts per conflict and correctly applies replace or duplicate outcomes.
</verification>

<success_criteria>
- STOR-05/06/07 export paths are available and functional from the per-chat 3-dot menu.
- STOR-08 import path is guided, validated, and conflict-aware.
- Transfer logic is covered by focused tests to prevent data corruption regressions.
</success_criteria>

<output>
After completion, create `.planning/phases/05-polish-and-pwa/05-03-SUMMARY.md`
</output>
