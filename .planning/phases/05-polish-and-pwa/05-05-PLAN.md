---
phase: 05-polish-and-pwa
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/chat-layout/ChatLayout.tsx
  - src/components/chat-layout/AppSidebar.tsx
  - src/components/ui/sidebar.tsx
  - src/components/ui/sheet.tsx
  - src/components/chat-layout/ChatLayout.mobile-sidebar-regression.test.tsx
autonomous: false
gap_closure: true
requirements:
  - CHAT-09
must_haves:
  truths:
    - "Opening the mobile sidebar no longer crashes with a Maximum update depth exceeded React error"
    - "Mobile sidebar can open/close repeatedly and still preserves single-panel focus behavior"
    - "Desktop sidebar behavior remains unchanged while mobile drawer recursion is eliminated"
  artifacts:
    - path: "src/components/chat-layout/ChatLayout.tsx"
      provides: "Single-direction mobile panel synchronization without cyclical state effects"
      exports: ["ChatLayout"]
    - path: "src/components/ui/sidebar.tsx"
      provides: "Guarded mobile open-state updates that avoid redundant state churn"
      exports: ["SidebarProvider", "Sidebar", "useSidebar"]
    - path: "src/components/chat-layout/AppSidebar.tsx"
      provides: "Mobile drawer close behavior that does not trigger re-open loops"
      exports: ["AppSidebar"]
    - path: "src/components/chat-layout/ChatLayout.mobile-sidebar-regression.test.tsx"
      provides: "Regression coverage for mobile sidebar toggle/open-close loop prevention"
  key_links:
    - from: "src/components/chat-layout/ChatLayout.tsx"
      to: "src/components/ui/sidebar.tsx"
      via: "mobilePanel <-> openMobile synchronization path"
      pattern: "openMobile|setOpenMobile|mobilePanel"
    - from: "src/components/chat-layout/AppSidebar.tsx"
      to: "src/components/ui/sidebar.tsx"
      via: "setOpenMobile(false) on mobile conversation actions"
      pattern: "setOpenMobile\(false\)"
---

<objective>
Close the human-reported Phase 5 regression where opening the sidebar on mobile triggers a React recursion crash (`Maximum update depth exceeded`) through `Presence/DialogPortal/Sheet` paths.

Purpose: Restore reliable mobile navigation so Phase 5 responsive behavior can be verified and accepted.
Output: Targeted state-loop fix, regression test coverage, and explicit reproduction/validation evidence.
</objective>

<execution_context>
@/Users/poak/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/poak/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-polish-and-pwa/05-CONTEXT.md
@.planning/phases/05-polish-and-pwa/05-VERIFICATION.md
@.planning/phases/05-polish-and-pwa/05-01-SUMMARY.md
@src/components/chat-layout/ChatLayout.tsx
@src/components/chat-layout/AppSidebar.tsx
@src/components/ui/sidebar.tsx
@src/components/ui/sheet.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Reproduce mobile sidebar recursion and remove cyclical state synchronization</name>
  <files>
    src/components/chat-layout/ChatLayout.tsx
    src/components/chat-layout/AppSidebar.tsx
    src/components/ui/sidebar.tsx
    src/components/ui/sheet.tsx
  </files>
  <action>
    Reproduce the reported failure path on mobile viewport (sidebar trigger -> Sheet open -> Presence/DialogPortal stack -> maximum update depth). Refactor sidebar state wiring so mobile panel intent has one authoritative direction and effects do not re-trigger each other in loops. Add guards for idempotent state transitions (no-op when target value already equals current value), and keep existing single-panel mobile focus behavior from 05-01 intact.
  </action>
  <verify>
    - npm run type-check
    - npm run lint
    - Run app, set viewport to iPhone width (~375px), open/close sidebar 10+ times; no "Maximum update depth exceeded" error appears in console
    - Open sidebar, then memory/performance/download panels; only one mobile panel remains open at a time
  </verify>
  <done>
    - Mobile sidebar open/close no longer causes React update-depth recursion
    - State synchronization between ChatLayout and Sidebar is one-way or safely guarded against feedback loops
    - Existing mobile panel exclusivity behavior still works
  </done>
</task>

<task type="auto">
  <name>Task 2: Add regression coverage for mobile sidebar open-state loop prevention</name>
  <files>
    src/components/chat-layout/ChatLayout.mobile-sidebar-regression.test.tsx
    src/components/chat-layout/ChatLayout.tsx
    src/components/ui/sidebar.tsx
  </files>
  <action>
    Add a focused regression test that mounts ChatLayout in mobile mode, triggers sidebar open/close interactions, and asserts no runaway render/update loop occurs while expected open-state transitions still happen. Cover the previously failing sequence where sidebar open state and mobile panel state attempted to mirror each other repeatedly.
  </action>
  <verify>
    - npm run test -- ChatLayout.mobile-sidebar-regression
    - Test asserts stable render count/state transitions for repeated sidebar toggle cycles
    - Existing sidebar/chat layout tests (if present) continue to pass
  </verify>
  <done>
    - Regression test fails before fix and passes after fix
    - Test captures the mobile recursion pathway that caused the human verification blocker
    - Future changes to sidebar/mobile synchronization are protected by automated coverage
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Human-verify mobile sidebar recursion is resolved</name>
  <action>
    Execute targeted manual validation on mobile viewport to confirm the previously reported sidebar-open crash path is fully resolved and panel interactions remain stable.
  </action>
  <what-built>Mobile sidebar recursion fix with regression coverage for update-loop prevention</what-built>
  <how-to-verify>
    1. Start app in dev mode and open `/chat` on mobile viewport (~375px width).
    2. Click sidebar button in the compact header; confirm drawer opens without console errors.
    3. Close drawer, reopen it, and repeat at least 10 times.
    4. While drawer is open, switch to memory panel and performance/download panel actions; confirm only one panel is visible at a time.
    5. Open sidebar again after interacting with other panels; confirm no crash and no React "Maximum update depth exceeded" error.
    6. Repeat quick open/close interactions for ~30 seconds to stress the prior recursion path.
    Expected result: no recursion error, no UI freeze, and mobile navigation remains functional.
  </how-to-verify>
  <resume-signal>Type "approved" if the recursion bug is gone, or provide exact failing step + console trace.</resume-signal>
  <verify>Complete all numbered manual checks without console recursion errors.</verify>
  <done>Human verification confirms the blocker is resolved or returns a precise failure report for follow-up.</done>
</task>

</tasks>

<verification>
1. Reproduce prior blocker path on mobile and confirm it no longer throws `Maximum update depth exceeded`.
2. Run type/lint/tests to validate no regressions in sidebar and layout behavior.
3. Complete blocking human verification sequence on a mobile viewport and capture pass/fail outcome.
</verification>

<success_criteria>
- CHAT-09 mobile sidebar interaction is stable and free of recursive update crashes.
- The exact human-reported blocker path is reproducible pre-fix and validated as resolved post-fix.
- A dedicated automated regression test exists to prevent recurrence of the mobile sidebar update loop.
</success_criteria>

<output>
After completion, create `.planning/phases/05-polish-and-pwa/05-05-SUMMARY.md`
</output>
