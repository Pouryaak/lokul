---
phase: 05-polish-and-pwa
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/chat-layout/ChatLayout.tsx
  - src/components/chat-layout/AppSidebar.tsx
  - src/components/chat-layout/compact-chat-header.tsx
  - src/components/chat-layout/mobile-panel-focus.ts
autonomous: true
requirements:
  - CHAT-09
must_haves:
  truths:
    - "Mobile defaults to chat view with a compact header while sidebar remains available via drawer"
    - "On mobile, opening one side panel closes other panels so overlays never stack"
    - "Desktop layout adapts density to narrower widths without breaking chat usability"
  artifacts:
    - path: "src/components/chat-layout/ChatLayout.tsx"
      provides: "Top-level responsive layout orchestration and panel state wiring"
      exports: ["ChatLayout"]
    - path: "src/components/chat-layout/compact-chat-header.tsx"
      provides: "Compact responsive header shell with left/right action regions"
      exports: ["CompactChatHeader"]
    - path: "src/components/chat-layout/mobile-panel-focus.ts"
      provides: "Single-source mobile panel focus controller"
      exports: ["MobilePanel", "createMobilePanelController"]
    - path: "src/components/chat-layout/AppSidebar.tsx"
      provides: "Conversation drawer behavior that respects mobile-only panel focus"
      exports: ["AppSidebar"]
  key_links:
    - from: "src/components/chat-layout/ChatLayout.tsx"
      to: "src/components/chat-layout/mobile-panel-focus.ts"
      via: "open/close handlers for memory, performance, and sidebar drawers"
      pattern: "mobilePanel|setMobilePanel"
    - from: "src/components/chat-layout/AppSidebar.tsx"
      to: "src/components/ui/sidebar.tsx"
      via: "mobile drawer close after selection"
      pattern: "setOpenMobile\(false\)"
---

<objective>
Implement the responsive shell decisions for Phase 5 by introducing a compact mobile-first chat header, drawer-first sidebar behavior on small screens, and a single-panel focus controller that prevents overlapping overlays.

Purpose: CHAT-09 depends on predictable responsive behavior; this plan creates the baseline shell constraints all later Phase 5 features plug into.
Output: Responsive chat layout updates, compact header scaffold, and mobile panel focus coordination.
</objective>

<execution_context>
@/Users/poak/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/poak/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-polish-and-pwa/05-CONTEXT.md
@.planning/phases/05-polish-and-pwa/05-RESEARCH.md
@src/components/chat-layout/ChatLayout.tsx
@src/components/chat-layout/AppSidebar.tsx
@src/components/ui/sidebar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add compact responsive header shell with adaptive density</name>
  <files>
    src/components/chat-layout/compact-chat-header.tsx
    src/components/chat-layout/ChatLayout.tsx
  </files>
  <action>
    Create `compact-chat-header.tsx` and refactor `ChatLayout.tsx` to use it as the chat-page top bar on desktop and mobile. Keep the header always visible on mobile, keep action zones compact, and support adaptive spacing classes so narrower desktop widths shift from comfortable to compact density. Include dedicated slots/props for left actions (memory/sidebar trigger) and right actions (downloads/performance/menu/install indicator) so later plans can integrate features without reworking layout structure.
  </action>
  <verify>
    - npm run type-check
    - Resize from 375px to 1280px width; header remains usable and visually compact on mobile
    - Desktop under narrow widths applies denser spacing while preserving all controls
  </verify>
  <done>
    - Chat layout uses a compact header component instead of inline header markup
    - Header behavior and spacing are responsive across mobile and desktop
    - Header supports extension points for Phase 5 menu/install actions
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement mobile single-panel focus controller</name>
  <files>
    src/components/chat-layout/mobile-panel-focus.ts
    src/components/chat-layout/ChatLayout.tsx
  </files>
  <action>
    Add a small controller module for mobile panel focus state (`none | sidebar | memory | performance | downloads`). Wire ChatLayout interactions so opening any one mobile panel closes the others automatically. Preserve current desktop behavior where multiple independent floating controls can remain available. Keep streaming auto-scroll and long-thread jump behavior unchanged.
  </action>
  <verify>
    - npm run type-check
    - On mobile viewport, open memory panel then open performance panel; memory closes automatically
    - On desktop viewport, existing panel behavior remains unchanged
  </verify>
  <done>
    - Mobile panel state has one authoritative source of truth
    - Mobile overlays no longer stack or conflict
    - Existing non-mobile panel behavior is preserved
  </done>
</task>

<task type="auto">
  <name>Task 3: Align sidebar drawer behavior with mobile chat-first default</name>
  <files>
    src/components/chat-layout/AppSidebar.tsx
    src/components/chat-layout/ChatLayout.tsx
  </files>
  <action>
    Ensure small-screen behavior defaults to chat content and uses the sidebar as a slide-over drawer only when invoked. After selecting a conversation on mobile, close the drawer and return focus to chat content. Keep desktop inset sidebar behavior intact.
  </action>
  <verify>
    - npm run type-check
    - On mobile viewport, initial route opens chat content (not persistent sidebar)
    - Selecting a conversation from drawer closes drawer and reveals selected chat
  </verify>
  <done>
    - Mobile users start in chat view with drawer-based navigation
    - Sidebar selection on mobile returns to chat view automatically
    - Desktop sidebar still behaves as before
  </done>
</task>

</tasks>

<verification>
1. Validate responsive behavior in mobile and desktop widths using browser devtools.
2. Confirm single-panel focus on mobile prevents overlapping overlays.
3. Confirm no regressions in desktop sidebar and existing chat interactions.
</verification>

<success_criteria>
- CHAT-09 responsive shell behavior matches locked Phase 5 layout decisions.
- Mobile users consistently interact with one panel at a time.
- Header structure is ready for menu/install additions in dependent plans.
</success_criteria>

<output>
After completion, create `.planning/phases/05-polish-and-pwa/05-01-SUMMARY.md`
</output>
