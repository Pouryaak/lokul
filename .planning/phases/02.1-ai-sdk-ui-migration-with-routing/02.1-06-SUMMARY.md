---
phase: 02.1-ai-sdk-ui-migration-with-routing
plan: 06
type: execute
subsystem: chat
requires:
  - 02.1-03
  - 02.1-05
provides:
  - persistence-integration
affects:
  - src/hooks/useAIChat.ts
  - src/routes/ChatDetailRoute.tsx
  - src/components/Chat/AIChatInterface.tsx
tech-stack:
  added:
    - useEffect persistence pattern
    - UIMessage to Message conversion
  patterns:
    - IndexedDB persistence with AI SDK UI
    - Route-based conversation loading
key-files:
  created: []
  modified:
    - src/hooks/useAIChat.ts
    - src/routes/ChatDetailRoute.tsx
    - src/components/Chat/AIChatInterface.tsx
decisions:
  - Use TextUIPart type from ai package for message part filtering
  - Store timestamp as Date.now() since UIMessage has no createdAt property
  - Convert storage messages to UIMessage format on route load
  - Handle missing conversations with toast warning and redirect
metrics:
  duration: 3m
  tasks: 3
  files: 3
  completed: 2026-02-18
---

# Phase 2.1 Plan 06: AI SDK UI Persistence Integration

**One-liner:** Integrated AI SDK UI with IndexedDB persistence so conversations are automatically saved after each message and loaded on route navigation.

---

## Summary

This plan completed the persistence layer integration between AI SDK UI and the existing IndexedDB storage system. The implementation ensures that:

1. Messages are automatically persisted to IndexedDB after each change
2. Conversations load correctly when navigating to `/chat/[id]`
3. Invalid conversation IDs are handled gracefully with user feedback
4. AI SDK UI state syncs bidirectionally with persistent storage

---

## Changes Made

### Task 1: Update useAIChat with Persistence

**File:** `src/hooks/useAIChat.ts`

Added persistence logic using useEffect to watch for message changes and save to IndexedDB:

- Imported `getConversation` and `saveConversation` from storage module
- Added `useEffect` that triggers when messages change
- Convert UIMessages to storage Message format using TextUIPart type
- Handle errors gracefully (logs to console but doesn't break chat)
- Update `conversation.updatedAt` timestamp on each save

**Key Implementation:**
```typescript
useEffect(() => {
  if (messages.length === 0) return;

  const persistMessages = async () => {
    try {
      const conversation = await getConversation(conversationId);
      if (!conversation) return;

      const storageMessages: Message[] = messages.map((msg): Message => ({
        id: msg.id,
        role: msg.role,
        content: msg.parts
          .filter((p): p is TextUIPart => p.type === "text")
          .map((p) => p.text)
          .join(""),
        timestamp: Date.now(),
        conversationId,
      }));

      conversation.messages = storageMessages;
      conversation.updatedAt = Date.now();

      await saveConversation(conversation);
    } catch (error) {
      console.error("Failed to persist conversation:", error);
    }
  };

  persistMessages();
}, [messages, conversationId]);
```

### Task 2: Update ChatDetailRoute to Load Conversation

**File:** `src/routes/ChatDetailRoute.tsx`

Updated route component to load conversation from storage and convert to AI SDK UI format:

- Load conversation using `getConversation(id)` on mount
- Handle "not found" case with toast warning and redirect to `/chat`
- Convert storage `Message[]` to `UIMessage[]` format
- Pass `initialMessages` and `modelId` to `AIChatInterface`
- Show loading spinner while fetching conversation

**Key Implementation:**
```typescript
const initialMessages: UIMessage[] = conversation.messages.map((msg) => ({
  id: msg.id,
  role: msg.role,
  content: msg.content,
  parts: [{ type: "text" as const, text: msg.content }],
}));

return (
  <AIChatInterface
    conversationId={id!}
    modelId={conversation.model}
    initialMessages={initialMessages}
  />
);
```

### Task 3: Update AIChatInterface to Accept initialMessages

**File:** `src/components/Chat/AIChatInterface.tsx`

Updated component props to accept and pass through initial messages:

- Added `initialMessages?: UIMessage[]` to props interface
- Pass `initialMessages` to `useAIChat` hook
- Component handles both new conversations (empty) and existing (with messages)

---

## Deviations from Plan

None - plan executed exactly as written.

---

## Verification Steps

1. Navigate to `/chat` - creates new conversation
2. Send a message - persists to IndexedDB
3. Refresh page - conversation loads with messages
4. Navigate to `/chat/[id]` - loads correct conversation
5. Invalid ID shows toast and redirects

---

## Commits

| Hash | Message | Files |
|------|---------|-------|
| 52933bb | feat(02.1-06): add persistence to useAIChat hook | src/hooks/useAIChat.ts |
| 03212e3 | feat(02.1-06): integrate AI SDK UI with persistent storage | src/routes/ChatDetailRoute.tsx, src/components/Chat/AIChatInterface.tsx |

---

## Self-Check: PASSED

- [x] All files modified exist
- [x] All commits exist in git history
- [x] TypeScript type-check passes
- [x] No lint errors introduced

---

## Notes

- The persistence uses `TextUIPart` type from the `ai` package for proper type narrowing when filtering message parts
- Since `UIMessage` doesn't have a `createdAt` property, we use `Date.now()` for the timestamp when converting to storage format
- The persistence effect only triggers when `messages.length > 0` to avoid unnecessary saves on initial mount
- Error handling is graceful - persistence failures are logged but don't break the chat experience
