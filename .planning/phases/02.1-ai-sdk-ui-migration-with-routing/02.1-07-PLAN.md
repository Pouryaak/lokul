---
phase: 02.1-ai-sdk-ui-migration-with-routing
plan: 07
type: execute
wave: 4
depends_on: ["02.1-06"]
files_modified:
  - src/App.tsx
  - src/components/performance/StatusIndicator.tsx
  - src/components/performance/PerformancePanel.tsx
autonomous: true
requirements:
  - CHAT-03
  - CHAT-08
must_haves:
  truths:
    - "Performance panel shows tokens/second during generation"
    - "Status indicator displays in chat interface"
    - "Model switching creates new conversation"
    - "All existing features work with new routing"
  artifacts:
    - path: "src/App.tsx"
      provides: "Updated with performance components"
      exports: ["App"]
    - path: "src/components/chat/AIChatInterface.tsx"
      provides: "Updated with performance integration"
      exports: ["AIChatInterface"]
  key_links:
    - from: "AIChatInterface"
      to: "PerformancePanel"
      via: "component composition"
      pattern: "{showPerformance && <PerformancePanel />}"
---

<objective>
Integrate performance monitoring and status indicators into the new chat interface. Ensure all existing features work with the AI SDK UI migration.

Purpose: Performance monitoring was built in Phase 2 and must continue working with the new architecture. Status indicators provide user feedback about system state.
Output: Fully integrated performance monitoring with the routed chat interface.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@/Users/poak/Documents/personal-project/Lokul/src/components/performance/StatusIndicator.tsx
@/Users/poak/Documents/personal-project/Lokul/src/components/performance/PerformancePanel.tsx
@/Users/poak/Documents/personal-project/Lokul/src/components/chat-layout/ChatLayout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate performance components into chat layout</name>
  <files>src/components/chat-layout/ChatLayout.tsx, src/components/chat/AIChatInterface.tsx</files>
  <action>
    Add StatusIndicator and PerformancePanel to the chat layout.

    Update ChatLayout.tsx to include:
    1. StatusIndicator - fixed bottom-left (always visible)
    2. Performance toggle button - top-right
    3. PerformancePanel - conditionally rendered

    ```tsx
    export function ChatLayout() {
      const [showPerformance, setShowPerformance] = useState(false);

      return (
        <SidebarProvider>
          <AppSidebar />
          <main className="flex-1 overflow-hidden relative">
            {/* Performance Toggle - Top Right */}
            <div className="absolute top-4 right-4 z-40">
              <Button
                variant="outline"
                size="sm"
                onClick={() => setShowPerformance(!showPerformance)}
              >
                <Activity className="h-4 w-4" />
              </Button>
            </div>

            {/* Performance Panel */}
            {showPerformance && (
              <div className="absolute top-16 right-4 z-40">
                <PerformancePanel onClose={() => setShowPerformance(false)} />
              </div>
            )}

            {/* Main Content */}
            <div className="h-full">
              <Outlet />
            </div>

            {/* Status Indicator - Bottom Left */}
            <StatusIndicator />
          </main>
        </SidebarProvider>
      );
    }
    ```

    Import required components:
    - StatusIndicator from '@/components/performance/StatusIndicator'
    - PerformancePanel from '@/components/performance/PerformancePanel'
    - Button from '@/components/ui/Button'
    - Activity icon from lucide-react

    The StatusIndicator should always be visible in the bottom-left corner.
    The PerformancePanel toggles on/off from the top-right button.
  </action>
  <verify>Performance toggle button appears and panel shows/hides on click</verify>
  <done>Performance components integrated into chat layout</done>
</task>

<task type="auto">
  <name>Task 2: Wire performance metrics to AI SDK UI</name>
  <files>src/lib/ai/webllm-transport.ts, src/hooks/useAIChat.ts</files>
  <action>
    Update the WebLLM transport to report performance metrics during streaming.

    The performance system expects metrics to be recorded. Update webllm-transport.ts:

    ```typescript
    import { recordMetrics, recordToken } from '@/lib/performance/metrics';

    async *sendMessage(options: { messages: UIMessage[] }) {
      // ... initialization ...

      const startTime = performance.now();
      let tokenCount = 0;

      try {
        const stream = inferenceManager.generate(inferenceMessages);

        for await (const token of stream) {
          if (signal.aborted) break;

          tokenCount++;
          recordToken(); // Track tokens for TPS calculation

          yield { type: 'text', content: token };
        }

        // Record final metrics
        const duration = performance.now() - startTime;
        recordMetrics({
          tokensGenerated: tokenCount,
          duration,
          timestamp: Date.now(),
        });

        yield { type: 'finish' };
      } catch (error) {
        // ... error handling ...
      }
    }
    ```

    Import recordMetrics and recordToken from the performance module.

    This ensures:
    1. Tokens are counted during streaming
    2. Duration is measured
    3. Metrics are recorded for the performance panel
    4. TPS (tokens per second) is calculated correctly

    The performance panel will automatically display these metrics.
  </action>
  <verify>Performance panel shows tokens/second during generation</verify>
  <done>Performance metrics wired to streaming in transport</done>
</task>

<task type="auto">
  <name>Task 3: Add model selector to chat interface</name>
  <files>src/components/chat/AIChatInterface.tsx, src/components/chat-layout/AppSidebar.tsx</files>
  <action>
    Add model switching UI that creates a new conversation when model changes.

    In AppSidebar.tsx, add a model selector dropdown:
    ```tsx
    const currentModel = useModelStore((state) => state.currentModel);
    const navigate = useNavigate();

    const handleModelChange = (modelId: string) => {
      // Navigate to /chat to create new conversation with selected model
      navigate('/chat');
    };
    ```

    Or add the model selector to AIChatInterface header:
    ```tsx
    <div className="flex items-center justify-between border-b px-4 py-2">
      <h1 className="font-semibold">Chat</h1>
      <ModelSelector
        currentModel={currentModel}
        onModelChange={handleModelChange}
      />
    </div>
    ```

    Per user decision: "Changing model creates a new chat with the chosen model".
    When user selects a different model:
    1. Update the model store
    2. Navigate to /chat (which creates new conversation)
    3. New conversation uses the newly selected model

    Create a simple ModelSelector component or use a Select from shadcn:
    ```tsx
    <Select value={currentModel?.id} onValueChange={handleModelChange}>
      <SelectTrigger className="w-[180px]">
        <SelectValue placeholder="Select model" />
      </SelectTrigger>
      <SelectContent>
        {AVAILABLE_MODELS.map((model) => (
          <SelectItem key={model.id} value={model.id}>
            {model.name}
          </SelectItem>
        ))}
      </SelectContent>
    </Select>
    ```

    Import AVAILABLE_MODELS from '@/lib/ai/models'.
  </action>
  <verify>Model selector appears and creates new chat on change</verify>
  <done>Model switching creates new conversation with selected model</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Status indicator visible in bottom-left
2. Performance toggle works in top-right
3. Performance panel shows tokens/second during generation
4. Model selector creates new conversation on change
5. All Phase 2 features work with new routing
</verification>

<success_criteria>
- StatusIndicator visible in chat layout
- PerformancePanel toggles and displays metrics
- Tokens/second calculated during streaming
- Model switching creates new conversation
- No regression in existing features
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-ai-sdk-ui-migration-with-routing/02.1-07-SUMMARY.md`
</output>
